 ; Copyright (c) 2011 The University of Utah
 ;
 ; Permission is hereby granted, free of charge, to any person obtaining a copy
 ; of this software and associated documentation files (the "Software"), to
 ; deal in the Software without restriction, including without limitation the
 ; rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
 ; sell copies of the Software, and to permit persons to whom the Software is
 ; furnished to do so, subject to the following conditions:
 ;
 ; The above copyright notice and this permission notice shall be included in
 ; all copies or substantial portions of the Software.
 ;
 ; THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 ; IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 ; FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 ; AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 ; LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 ; FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
 ; IN THE SOFTWARE.

(let* ([id (lambda (x) x)]
       [c concat-chunk]
       [b between-chunk]
       [b/a between/attach-chunk]
       [n namespace-define-chunk]
       [i (lambda chunks (between/attach-chunk semi-colon-chunk blank-line-chunk chunks))]
       [d described-smts-chunk]
       [p paren-list-chunk]
       [m macro-define-chunk]
       [s space-chunk]
       [typedef typedef-smt-chunk]
       [fc function-call-chunk]
       [mfc member-function-call-chunk]
       [fcn-def function-define-chunk]
       [v-fcn-def void-function-define-chunk]
       [r-fcn-def returning-function-define-chunk]
       [fcn-dcl function-declare-chunk]
       [constize constize-chunk]
       [s-fcn-dcl static-function-declare-chunk]
       [tpl-def template-define-chunk]
       [srt-dcl struct-declare-chunk]
       [srt-def struct-define-chunk]
       [tpl-srt-dcl template-struct-declare-chunk]
       [tpl-srt-def template-struct-define-chunk]
       [tpl-use template-use-chunk]
       [tpl-pmtr (lambda (pmtr) (c typename-chunk s pmtr))]
       [sub-tpl-use (lambda (pmtr) (c template-chunk s pmtr))]
       [tpl-fcn-use (lambda pmtrs (sub-tpl-use (apply tpl-use pmtrs)))]
       [sec-def section-define-chunk]
       [cons-asgn constructor-assignment-chunk]
       [scope scope-resolution-operator-chunk]
       [report-VG-chunk 'PossibleValidGhost]
       [VG-chunk 'ValidGhost]
       [SH-chunk 'Shift]
       [NE-chunk 'NeboExpression]
       [NBE-chunk 'NeboBooleanExpression]
       [FT-chunk 'FieldType]
       [NS-chunk 'NeboScalar]
       [NB-chunk 'NeboBoolean]
       [NCF-chunk 'NeboConstField]
       [NF-chunk 'NeboField]
       [Pair-chunk 'NeboPair]
       [Quad-chunk 'NeboQuad]
       [Nil-chunk 'NeboNil]
       [SClause-chunk 'NeboSimpleClause]
       [SFClause-chunk 'NeboSimpleFinalClause]
       [SCond-chunk 'NeboSimpleCond]
       [Clause-chunk 'NeboClause]
       [Cond-chunk 'NeboCond]
       [CT-chunk 'ClauseType]
       [IntVec (scope 'structured 'IntVec)]
       [pp-header-file-chunk-with-license
        (lambda (file-name file-setup . chunks)
          (c (b new-line-chunk
                "/*"
                " * Copyright (c) 2011 The University of Utah"
                " *"
                " * Permission is hereby granted, free of charge, to any person obtaining a copy"
                " * of this software and associated documentation files (the \"Software\"), to"
                " * deal in the Software without restriction, including without limitation the"
                " * rights to use, copy, modify, merge, publish, distribute, sublicense, and/or"
                " * sell copies of the Software, and to permit persons to whom the Software is"
                " * furnished to do so, subject to the following conditions:"
                " *"
                " * The above copyright notice and this permission notice shall be included in"
                " * all copies or substantial portions of the Software."
                " *"
                " * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR"
                " * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,"
                " * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE"
                " * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER"
                " * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING"
                " * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS"
                " * IN THE SOFTWARE."
                " */")
             blank-line-chunk
             (pp-header-file-chunk file-name file-setup chunks)))]
       [IteratorStyle
        (lambda (iterator result-type)
          (d iterator
             (tpl-srt-def 'IteratorStyle
                          (list (tpl-pmtr 'FirstType)
                                (tpl-pmtr 'SecondType))
                          (list iterator 'FirstType 'SecondType)
                          (typedef result-type 'result))))]
       [TemplateIf
        (lambda (result result-type)
          (d result
             (tpl-srt-def 'TemplateIf
                          (list (tpl-pmtr 'TrueResult)
                                (tpl-pmtr 'FalseResult))
                          (list result 'TrueResult 'FalseResult)
                          (typedef result-type 'result))))]
       [build-expression-type
        (lambda (name)
          (tpl-srt-def name
                       (list (tpl-pmtr 'Operand)
                             (tpl-pmtr FT-chunk))
                       null
                       (sec-def public-chunk
                                (typedef FT-chunk 'field_type)
                                (typedef 'Operand 'Expression)
                                (constructor-chunk name
                                                   (b s 'Operand const-chunk "&" 'given)
                                                   (cons-asgn 'expr_ 'given))
                                (r-fcn-def (constize (fcn-dcl 'expr
                                                              (b s 'Operand const-chunk "&")))
                                           null
                                           'expr_))
                       (sec-def private-chunk
                                (c 'Operand s 'expr_))))]
       [build-mode-def (lambda (name templated?)
                         (if templated?
                             (tpl-srt-dcl name
                                          (list (tpl-pmtr VG-chunk)
                                                (tpl-pmtr SH-chunk)))
                             (struct-declare-chunk name)))]
       [bm-constructor
        (lambda (params
                 assigns
                 body)
          (list params
                assigns
                body))]
       [build-mode
        (lambda (name
                 mode
                 tpl-pars
                 tpl-args
                 typedefs
                 constructor
                 publics
                 privates)
          (let ([constructor-params first]
                [constructor-assigns second]
                [constructor-body third])
            (tpl-srt-def name
                         (flatten* tpl-pars (tpl-pmtr FT-chunk))
                         (flatten* mode tpl-args FT-chunk)
                         (sec-def public-chunk
                                  (typedef FT-chunk
                                           'field_type)
                                  (typedef (scope (tpl-pmtr FT-chunk)
                                                  'memory_window)
                                           'MemoryWindow)
                                  typedefs
                                  (constructor-chunk name
                                                     (constructor-params constructor)
                                                     (constructor-assigns constructor)
                                                     (constructor-body constructor))
                                  publics)
                         (sec-def private-chunk
                                  privates))))]
       [bs-Initial
        (lambda (tpl-args-RP
                 tpl-args-SW
                 typedefs
                 VG-type
                 constructor
                 SW-cons-args
                 RP-cons-args
                 publics
                 privates)
          (list tpl-args-RP
                tpl-args-SW
                typedefs
                VG-type
                constructor
                SW-cons-args
                RP-cons-args
                publics
                privates))]
       [bs-ResizePrep
        (lambda (tpl-args-RS
                 typedefs
                 constructor
                 RS-cons-args
                 publics
                 privates)
          (list tpl-args-RS
                typedefs
                constructor
                RS-cons-args
                publics
                privates))]
       [bs-Resize
        (lambda (tpl-args-SW
                 typedefs
                 constructor
                 SW-cons-args
                 publics
                 privates)
          (list tpl-args-SW
                typedefs
                constructor
                SW-cons-args
                publics
                privates))]
       [bs-SeqWalk
        (lambda (typedefs
                 constructor
                 next
                 at-end
                 has-length
                 publics
                 privates)
          (list typedefs
                constructor
                next
                at-end
                has-length
                publics
                privates))]
       [build-struct
        (lambda (name
                 const?
                 tpl-pars
                 tpl-args
                 Initial
                 ResizePrep
                 Resize
                 SeqWalk)
          (let ([add-const (if const?
                               constize-chunk
                               id)]
                [IN-tpl-args-RP first]
                [IN-tpl-args-SW second]
                [IN-typedefs third]
                [IN-VG-type fourth]
                [IN-constructor fifth]
                [IN-SW-cons-args sixth]
                [IN-RP-cons-args seventh]
                [IN-publics eighth]
                [IN-privates ninth]
                [RP-tpl-args-RS first]
                [RP-typedefs second]
                [RP-constructor third]
                [RP-RS-cons-args fourth]
                [RP-publics fifth]
                [RP-privates sixth]
                [RS-tpl-args-SW first]
                [RS-typedefs second]
                [RS-constructor third]
                [RS-SW-cons-args fourth]
                [RS-publics fifth]
                [RS-privates sixth]
                [SW-typedefs first]
                [SW-constructor second]
                [SW-next third]
                [SW-at-end fourth]
                [SW-has-length fifth]
                [SW-publics sixth]
                [SW-privates seventh])
            (i (tpl-srt-dcl name
                            (list (tpl-pmtr 'CurrentMode)
                                  tpl-pars
                                  (tpl-pmtr FT-chunk))
                            null)
               (build-mode name
                           'Initial
                           tpl-pars
                           tpl-args
                           (list (IN-typedefs Initial)
                                 (tpl-srt-def 'Iterator
                                              (list (tpl-pmtr VG-chunk)
                                                    (tpl-pmtr SH-chunk))
                                              null
                                              (typedef (tpl-use name
                                                                (tpl-use 'ResizePrep VG-chunk SH-chunk)
                                                                (IN-tpl-args-RP Initial)
                                                                FT-chunk)
                                                       'ResizePrepType)
                                              (typedef (tpl-use name
                                                                (tpl-use 'SeqWalk VG-chunk SH-chunk)
                                                                (IN-tpl-args-SW Initial)
                                                                FT-chunk)
                                                       'SeqWalkType))
                                 (typedef (IN-VG-type Initial) report-VG-chunk))
                           (IN-constructor Initial)
                           (list (tpl-def (list (tpl-pmtr VG-chunk)
                                                (tpl-pmtr SH-chunk))
                                          (r-fcn-def (add-const (fcn-dcl 'init
                                                                         (tpl-pmtr (scope (tpl-use 'Iterator VG-chunk SH-chunk)
                                                                                          'SeqWalkType))))
                                                     null
                                                     (fc (tpl-pmtr (scope (tpl-use 'Iterator VG-chunk SH-chunk)
                                                                          'SeqWalkType))
                                                         (IN-SW-cons-args Initial))))
                                 (tpl-def (list (tpl-pmtr VG-chunk)
                                                (tpl-pmtr SH-chunk))
                                          (r-fcn-def (add-const (fcn-dcl 'resize_prep
                                                                         (tpl-pmtr (scope (tpl-use 'Iterator VG-chunk SH-chunk)
                                                                                          'ResizePrepType))))
                                                     null
                                                     (fc (tpl-pmtr (scope (tpl-use 'Iterator VG-chunk SH-chunk)
                                                                          'ResizePrepType))
                                                         (IN-RP-cons-args Initial))))
                                 (IN-publics Initial))
                           (IN-privates Initial))
               (build-mode name
                           (tpl-use 'ResizePrep VG-chunk SH-chunk)
                           (list (tpl-pmtr VG-chunk)
                                 (tpl-pmtr SH-chunk)
                                 tpl-pars)
                           tpl-args
                           (list (typedef (tpl-use name
                                                   (tpl-use 'Resize VG-chunk SH-chunk)
                                                   (RP-tpl-args-RS ResizePrep)
                                                   FT-chunk)
                                          'ResizeType)
                                 (RP-typedefs ResizePrep))
                           (RP-constructor ResizePrep)
                           (list (r-fcn-def (add-const (fcn-dcl 'resize
                                                                'ResizeType
                                                                (b s 'MemoryWindow const-chunk "&" 'size)
                                                                (b s IntVec const-chunk "&" 'split)
                                                                (b s IntVec const-chunk "&" 'location)))
                                            null
                                            (fc 'ResizeType
                                                (RP-RS-cons-args ResizePrep)))
                                 (RP-publics ResizePrep))
                           (RP-privates ResizePrep))
               (build-mode name
                           (tpl-use 'Resize VG-chunk SH-chunk)
                           (list (tpl-pmtr VG-chunk)
                                 (tpl-pmtr SH-chunk)
                                 tpl-pars)
                           tpl-args
                           (list (typedef (tpl-use name
                                                   (tpl-use 'SeqWalk VG-chunk SH-chunk)
                                                   (RS-tpl-args-SW Resize)
                                                   FT-chunk)
                                          'SeqWalkType)
                                 (RS-typedefs Resize))
                           (RS-constructor Resize)
                           (list (r-fcn-def (add-const (fcn-dcl 'init 'SeqWalkType))
                                            null
                                            (fc 'SeqWalkType
                                                (RS-SW-cons-args Resize)))
                                 (RS-publics Resize))
                           (RS-privates Resize))
               (build-mode name
                           (tpl-use 'SeqWalk VG-chunk SH-chunk)
                           (list (tpl-pmtr VG-chunk)
                                 (tpl-pmtr SH-chunk)
                                 tpl-pars)
                           tpl-args
                           (SW-typedefs SeqWalk)
                           (SW-constructor SeqWalk)
                           (list (v-fcn-def 'next
                                            null
                                            (SW-next SeqWalk))
                                 (r-fcn-def (constize (fcn-dcl 'at_end
                                                               'bool))
                                            null
                                            (SW-at-end SeqWalk))
                                 (r-fcn-def (constize (fcn-dcl 'has_length
                                                               'bool))
                                            null
                                            (SW-has-length SeqWalk))
                                 (SW-publics SeqWalk))
                           (SW-privates SeqWalk)))))]
       [build-Nary-struct
        (lambda (name number eval-return-type internal-use)
          (let* ([num-lst (if (>= 1 number)
                               '("")
                               (map number->string
                                    (sequence->list (in-range 1 (+ 1 number)))))]
                 [IN-op-lst (map (lambda (str) (c 'op str)) num-lst)]
                 [op-lst (map (lambda (str) (c 'operand str)) num-lst)]
                 [Op-lst (map (lambda (str) (c 'Operand str)) num-lst)]
                 [op_-lst (map (lambda (op) (c op "_")) op-lst)]
                 [mapper (lambda (proc . lsts)
                           (apply map proc lsts))]
                 [IN-typedef (lambda (type)
                               (lambda (Op)
                                 (tpl-pmtr (scope (scope Op (tpl-fcn-use 'Iterator VG-chunk SH-chunk))
                                                  type))))]
                 [build-VG (lambda (Op-VG-lst)
                             (cond [(equal? 1 (length Op-VG-lst)) (first Op-VG-lst)]
                                   [(equal? 2 (length Op-VG-lst)) (tpl-pmtr (scope (scope 'structured (tpl-use 'Minimum
                                                                                                               (first Op-VG-lst)
                                                                                                               (second Op-VG-lst)))
                                                                                   'result))]
                                   [else (tpl-pmtr (scope (scope 'structured
                                                                 (tpl-use 'Minimum
                                                                          (first Op-VG-lst)
                                                                          (build-VG (rest Op-VG-lst))))
                                                          'result))]))]
                 [gen-ext-fcns (mapper (lambda (op Op op_)
                                         (r-fcn-def (constize (fcn-dcl op (b s Op const-chunk "&")))
                                                    null
                                                    op_))
                                       op-lst
                                       Op-lst
                                       op_-lst)]
                 [gen-data-mems (mapper (lambda (Op op_) (b s Op const-chunk op_))
                                        Op-lst
                                        op_-lst)]
                 [gen-typedef (lambda (type) (lambda (Op) (tpl-pmtr (scope Op type))))]
                 [gen-constructor (bm-constructor (mapper (lambda (Op op) (b s Op const-chunk "&" op))
                                                          Op-lst
                                                          op-lst)
                                                  (mapper (lambda (op_ op) (cons-asgn op_ op))
                                                          op_-lst
                                                          op-lst)
                                                  null)]
                 [SW-fcn (lambda (att btwn fcn)
                           (b/a att btwn (mapper (lambda (op_) (mfc op_ fcn))
                                                 op_-lst)))]
                 [SW-check (lambda (fcn)
                             (p (SW-fcn empty-chunk
                                        (c s "||" s)
                                        fcn)))]
                 [SW-data-mems (mapper (lambda (Op op_) (c Op s op_))
                                       Op-lst
                                       op_-lst)])
            (build-struct name
                          #true
                          (mapper (lambda (Op) (tpl-pmtr Op))
                                  Op-lst)
                          Op-lst
                          (bs-Initial (mapper (IN-typedef 'ResizePrepType)
                                              Op-lst)
                                      (mapper (IN-typedef 'SeqWalkType)
                                              Op-lst)
                                      null
                                      (build-VG (mapper (lambda (Op) (tpl-pmtr (scope Op report-VG-chunk)))
                                                        Op-lst))
                                      gen-constructor
                                      (mapper (lambda (op) (mfc (fc op)
                                                                (tpl-fcn-use 'init VG-chunk SH-chunk)))
                                              op-lst)
                                      (mapper (lambda (op) (mfc (fc op)
                                                                (tpl-fcn-use 'resize_prep VG-chunk SH-chunk)))
                                              op-lst)
                                      gen-ext-fcns
                                      gen-data-mems)
                          (bs-ResizePrep (mapper (gen-typedef 'ResizeType)
                                                 Op-lst)
                                         null
                                         gen-constructor
                                         (mapper (lambda (op) (mfc (fc op)
                                                                   'resize
                                                                   'size
                                                                   'split
                                                                   'location))
                                                 op-lst)
                                         gen-ext-fcns
                                         gen-data-mems)
                          (bs-Resize (mapper (gen-typedef 'SeqWalkType)
                                             Op-lst)
                                     null
                                     gen-constructor
                                     (mapper (lambda (op) (mfc (fc op)
                                                               'init))
                                             op-lst)
                                     gen-ext-fcns
                                     gen-data-mems)
                          (bs-SeqWalk (typedef eval-return-type
                                               'EvalReturnType)
                                      gen-constructor
                                      (SW-fcn semi-colon-chunk s 'next)
                                      (SW-check 'at_end)
                                      (SW-check 'has_length)
                                      (r-fcn-def (constize (fcn-dcl 'eval 'EvalReturnType))
                                                 null
                                                 internal-use)
                                      SW-data-mems))))]
       [build-binary-function-struct
        (lambda (name internal-name)
          (build-Nary-struct name
                             2
                             (scope (tpl-pmtr FT-chunk)
                                    'value_type)
                             (fc internal-name
                                 (mfc 'operand1_ 'eval)
                                 (mfc 'operand2_ 'eval))))]
       [build-binary-operator-struct
        (lambda (name internal-name)
          (build-Nary-struct name
                             2
                             (scope (tpl-pmtr FT-chunk)
                                    'value_type)
                             (p (b s
                                   (mfc 'operand1_ 'eval)
                                   internal-name
                                   (mfc 'operand2_ 'eval)))))]
       [build-unary-function-struct
        (lambda (name internal-name)
          (build-Nary-struct name
                             1
                             (scope (tpl-pmtr FT-chunk)
                                    'value_type)
                             (fc internal-name
                                 (mfc 'operand_ 'eval))))]
       [build-comparison-struct
        (lambda (name internal-name)
          (build-Nary-struct name
                             2
                             'bool
                             (p (b s
                                   (mfc 'operand1_ 'eval)
                                   internal-name
                                   (mfc 'operand2_ 'eval)))))]
       [build-unary-logical-function-struct
        (lambda (name internal-name)
          (build-Nary-struct name
                             1
                             'bool
                             (fc internal-name
                                 (mfc 'operand_ 'eval))))]
       [build-logical-operator-struct
        (lambda (name internal-name)
          (build-Nary-struct name
                             2
                             'bool
                             (p (b s
                                   (mfc 'operand1_ 'eval)
                                   internal-name
                                   (mfc 'operand2_ 'eval)))))]
       [abs-SubExpr (lambda (str)
                      (let* ([SE (string-append "SubExpr" str)]
                             [arg (string-append "arg" str)]
                             [FT (scope (tpl-pmtr SE)
                                        'field_type)])
                        (list FT
                              SE
                              (lambda (FT)
                                (tpl-pmtr (scope (tpl-use 'Standardize SE FT)
                                                 'StandardType)))
                              (lambda (FT)
                                (b s SE const-chunk "&" arg))
                              (fc (scope (tpl-use 'Standardize SE FT-chunk)
                                         'standardType)
                                  arg))))]
       [abs-Scalar (lambda (str)
                     (let ([arg (string-append "arg" str)])
                       (list #false
                             #false
                             (lambda (FT)
                               (tpl-use NS-chunk 'Initial FT))
                             (lambda (FT)
                               (b s
                                  (scope FT 'value_type)
                                  const-chunk
                                  "&"
                                  arg))
                             (fc (c 'Type str)
                                 arg))))]
       [abs-SubBoolExpr (lambda (str)
                          (let* ([SE (string-append "SubBoolExpr" str)]
                                 [arg (string-append "arg" str)]
                                 [FT (scope (tpl-pmtr SE)
                                            'field_type)])
                            (list FT
                                  SE
                                  (lambda (FT)
                                    (tpl-pmtr (scope SE 'Expression)))
                                  (lambda (FT)
                                    (b s SE const-chunk "&" arg))
                                  (mfc arg 'expr))))]
       [abs-Boolean (lambda (str)
                      (let ([arg (string-append "arg" str)])
                        (list #false
                              #false
                              (lambda (FT)
                                (tpl-use NB-chunk 'Initial FT))
                              (lambda (FT)
                                (b s 'bool const-chunk "&" arg))
                              (fc (c 'Type str)
                                  arg))))]
       [build-interface-case
        (lambda (description-chunk abs-type-lst name external-name expression-term)
          (let* ([FT-clause first]
                 [tpl-arg second]
                 [StdType third]
                 [parameter fourth]
                 [argument fifth]
                 [number (length abs-type-lst)]
                 [num-lst (if (>= 1 number)
                              '("")
                              (map number->string (sequence->list (in-range 1 (+ 1 number)))))]
                 [type-lst (map (lambda (abs-type str) (abs-type str))
                                abs-type-lst
                                num-lst)]
                 [Type-lst (map (lambda (str) (string-append "Type" str))
                                num-lst)]
                 [mapper (lambda (proc)
                           (map proc type-lst))]
                 [tpl-arg-lst (map (lambda (type) (tpl-pmtr type))
                                   (reverse (foldl (lambda (next crt) (if next
                                                                          (cons next crt)
                                                                          crt))
                                                   null
                                                   (mapper (lambda (type) (tpl-arg type))))))]
                 [FT (foldl (lambda (type crt) (cond [crt]
                                                     [(FT-clause type)]
                                                     [else #false]))
                            #false
                            type-lst)]
                 [StdType-lst (mapper (lambda (type) ((StdType type) FT)))]
                 [parameter-lst (mapper (lambda (type) ((parameter type) FT)))]
                 [StdType-typedef-lst (map (lambda (StdType Type) (typedef StdType Type))
                                           StdType-lst
                                           Type-lst)]
                 [arg-use-lst (map (lambda (Type type) (fc Type (argument type)))
                                   Type-lst
                                   type-lst)])
            (if (not FT)
                "ERROR: No FieldType found for use in a build-interface-case"
                (d description-chunk
                   (tpl-def tpl-arg-lst
                            (r-fcn-def
                             (fcn-dcl external-name
                                      (tpl-use expression-term
                                               (tpl-use name 'Initial StdType-lst FT)
                                               FT)
                                      parameter-lst)
                             (list (typedef FT FT-chunk)
                                   StdType-typedef-lst
                                   (typedef (tpl-use name 'Initial Type-lst FT-chunk)
                                            'ReturnType)
                                   (typedef (tpl-use expression-term 'ReturnType FT-chunk)
                                            'ReturnTerm))
                             (fc 'ReturnTerm (fc 'ReturnType arg-use-lst))))))))]
       [build-binary-interface
        (lambda (name
                 external-name
                 expression-term
                 Expr-abs
                 Expr-str
                 Val-abs
                 Val-str)
          (smt-list-chunk blank-line-chunk
                          (build-interface-case (c Expr-str s "X" s Expr-str)
                                                (list Expr-abs Expr-abs)
                                                name
                                                external-name
                                                expression-term)
                          (build-interface-case (c Expr-str s "X" s Val-str)
                                                (list Expr-abs Val-abs)
                                                name
                                                external-name
                                                expression-term)
                          (build-interface-case (c Val-str s "X" s Expr-str)
                                                (list Val-abs Expr-abs)
                                                name
                                                external-name
                                                expression-term)))]
       [build-unary-interface
        (lambda (name
                 external-name
                 expression-term
                 Expr-abs
                 Expr-str)
         (build-interface-case Expr-str
                               (list Expr-abs)
                               name
                               external-name
                               expression-term))]
       [build-binary-function
        (lambda (name internal-name external-name)
          (smt-list-chunk blank-line-chunk
                          (build-binary-function-struct name internal-name)
                          (build-binary-interface name external-name NE-chunk abs-SubExpr 'SubExpr abs-Scalar 'Scalar)))]
       [build-binary-operator
        (lambda (name internal-name external-name)
          (smt-list-chunk blank-line-chunk
                          (build-binary-operator-struct name internal-name)
                          (build-binary-interface name external-name NE-chunk abs-SubExpr 'SubExpr abs-Scalar 'Scalar)))]
       [build-unary-function
        (lambda (name internal-name external-name)
          (smt-list-chunk blank-line-chunk
                          (build-unary-function-struct name internal-name)
                          (build-unary-interface name external-name NE-chunk abs-SubExpr 'SubExpr)))]
       [build-comparison-operator
        (lambda (name internal-name external-name)
          (smt-list-chunk blank-line-chunk
                          (build-comparison-struct name internal-name)
                          (build-binary-interface name external-name NBE-chunk abs-SubExpr 'SubExpr abs-Scalar 'Scalar)))]
       [build-binary-logical-operator
        (lambda (name internal-name external-name)
          (smt-list-chunk blank-line-chunk
                          (build-binary-operator-struct name internal-name)
                          (build-binary-interface name external-name NBE-chunk abs-SubBoolExpr 'SubBoolExpr abs-Boolean 'Boolean)))]
       [build-unary-logical-function
        (lambda (name internal-name external-name)
          (smt-list-chunk blank-line-chunk
                          (build-unary-function-struct name internal-name)
                          (build-unary-interface name external-name NBE-chunk abs-SubBoolExpr 'SubBoolExpr)))]
       [build-assignment
        (lambda (name tpl-pmtrs rhs-type body return-expr)
          (tpl-def (list tpl-pmtrs
                         (tpl-pmtr FT-chunk))
                   (r-fcn-def (fcn-dcl name
                                       (b s FT-chunk const-chunk "&")
                                       (b s FT-chunk "&" 'lhs)
                                       (b s rhs-type const-chunk "&" 'rhs))
                              body
                              return-expr)))]
       [build-assignment-style
        (lambda (name rec-call iterator)
          (smt-list-chunk blank-line-chunk
                          (build-assignment name
                                            null
                                            (scope (tpl-pmtr FT-chunk)
                                                   'value_type)
                                            (typedef (tpl-use NS-chunk 'Initial FT-chunk)
                                                     'ExprType)
                                            rec-call)
                          (build-assignment name
                                            null
                                            FT-chunk
                                            (typedef (tpl-use NCF-chunk 'Initial FT-chunk)
                                                     'ExprType)
                                           rec-call)
                          (build-assignment name
                                            (tpl-pmtr 'ExprType)
                                            (tpl-use NE-chunk 'ExprType FT-chunk)
                                            null
                                            (fc (tpl-use 'nebo_assignment_general_execute iterator 'ExprType FT-chunk)
                                                'lhs
                                                'rhs))))]
       )
  ; beginnning of file
  (pp-header-file-chunk-with-license
   'SpatialOps_FieldExpressions_h
   (b blank-line-chunk
      (pp-includes-chunk 'spatialops/SpatialOpsConfigure.h
                         'spatialops/structured/IndexTriplet.h
                         'spatialops/structured/GhostData.h
                         'spatialops/structured/SpatialField.h
                         'cmath)
      (comment-env-chunk (pp-include-chunk 'iostream))
      (pp-conditional-ifdef-chunk
       'FIELD_EXPRESSION_THREADS
       (b new-line-chunk
          (pp-includes-chunk 'vector
                             'boost/bind.hpp
                             'spatialops/ThreadPool.h
                             'spatialops/structured/IntVec.h
                             'boost/interprocess/sync/interprocess_semaphore.hpp)
          "namespace BI = boost::interprocess;")))
   (n 'SpatialOps
      (pp-conditional-ifdef-chunk
       'FIELD_EXPRESSION_THREADS
       (b new-line-chunk
          (comment-env-chunk "used within nebo to determine if thread parallelism should be used")
          (c 'bool
             s
             (fc 'is_nebo_thread_parallel
                 'void)
             semi-colon-chunk)
          (comment-env-chunk "used within nebo to get current soft (active) thread count")
          (c 'int
             s
             (fc 'get_nebo_soft_thread_count
                 'void)
             semi-colon-chunk)
          (comment-env-chunk "used by tests to change current soft (active) thread count at runtime")
          (c 'int
             s
             (fc 'set_nebo_soft_thread_count
                 (c 'int s 'thread_count))
             semi-colon-chunk)
          (comment-env-chunk "used within nebo to get current hard (max/total) thread count")
          (c 'int
             s
             (fc 'get_nebo_hard_thread_count
                 'void)
             semi-colon-chunk)
          (comment-env-chunk "used by tests to change current hard (max/total) thread count at runtime")
          (c 'int
             s
             (fc 'set_nebo_hard_thread_count
                 (c 'int s 'thread_count))
             semi-colon-chunk)))
      (d "Meta-programming compiler flags"
         (struct-declare-chunk 'UseWholeIterator)
         (struct-declare-chunk 'UseInteriorIterator))
      (tpl-srt-dcl 'IteratorStyle
                   (list (tpl-pmtr 'IteratorType)
                         (tpl-pmtr 'FirstType)
                         (tpl-pmtr 'SecondType))
                   null)
      (IteratorStyle 'UseWholeIterator 'FirstType)
      (IteratorStyle 'UseInteriorIterator 'SecondType)
      (tpl-srt-dcl 'TemplateIf
                   (list (c 'bool s 'Boolean)
                         (tpl-pmtr 'FirstType)
                         (tpl-pmtr 'SecondType))
                   null)
      (TemplateIf 'true 'TrueResult)
      (TemplateIf 'false 'FalseResult)
      (build-expression-type NE-chunk)
      (build-expression-type NBE-chunk)
      (d 'Modes:
         (build-mode-def 'Initial #false)
         (build-mode-def 'ResizePrep #true)
         (build-mode-def 'Resize #true)
         (build-mode-def 'SeqWalk #true))
      (build-struct NS-chunk
                    #true
                    null
                    null
                    (bs-Initial null
                                null
                                (typedef (scope (tpl-pmtr FT-chunk)
                                                'value_type)
                                         'AtomicType)
                                (scope 'structured 'InfiniteGhostData)
                                (bm-constructor (b s 'AtomicType const-chunk 'v)
                                                (cons-asgn 'value_ 'v)
                                                null)
                                (fc 'value)
                                (fc 'value)
                                (r-fcn-def (constize (fcn-dcl 'value
                                                              (b s 'AtomicType const-chunk)))
                                           null
                                           'value_)
                                (b s 'AtomicType const-chunk 'value_))
                    (bs-ResizePrep null
                                   (typedef (scope (tpl-pmtr FT-chunk)
                                                   'value_type)
                                            'AtomicType)
                                   (bm-constructor (b s 'AtomicType const-chunk 'value)
                                                   (cons-asgn 'value_ 'value)
                                                   null)
                                   (fc 'value)
                                   (r-fcn-def (constize (fcn-dcl 'value
                                                                 (b s 'AtomicType const-chunk)))
                                              null
                                              'value_)
                                (b s 'AtomicType const-chunk 'value_))
                    (bs-Resize null
                               (typedef (scope (tpl-pmtr FT-chunk)
                                               'value_type)
                                        'AtomicType)
                               (bm-constructor (b s 'AtomicType const-chunk 'value)
                                               (cons-asgn 'value_ 'value)
                                               null)
                               (fc 'value)
                               (r-fcn-def (constize (fcn-dcl 'value
                                                             (b s 'AtomicType const-chunk)))
                                          null
                                          'value_)
                                (b s 'AtomicType const-chunk 'value_))
                    (bs-SeqWalk (typedef (scope (tpl-pmtr FT-chunk)
                                                'value_type)
                                         'AtomicType)
                                (bm-constructor (b s 'AtomicType const-chunk 'value)
                                                (cons-asgn 'value_ 'value)
                                                null)
                                null
                                'false
                                'false
                                (r-fcn-def (constize (fcn-dcl 'eval
                                                              (b s 'AtomicType const-chunk)))
                                          null
                                          'value_)
                                (b s 'AtomicType const-chunk 'value_)))
      (build-struct NB-chunk
                    #true
                    null
                    null
                    (bs-Initial null
                                null
                                null
                                (scope 'structured 'InfiniteGhostData)
                                (bm-constructor (b s 'bool const-chunk 'v)
                                                (cons-asgn 'value_ 'v)
                                                null)
                                (fc 'value)
                                (fc 'value)
                                (r-fcn-def (constize (fcn-dcl 'value
                                                              (b s 'bool const-chunk)))
                                           null
                                           'value_)
                                (b s 'bool const-chunk 'value_))
                    (bs-ResizePrep null
                                   null
                                   (bm-constructor (b s 'bool const-chunk 'value)
                                                   (cons-asgn 'value_ 'value)
                                                   null)
                                   (fc 'value)
                                   (r-fcn-def (constize (fcn-dcl 'value
                                                                 (b s 'bool const-chunk)))
                                              null
                                              'value_)
                                (b s 'bool const-chunk 'value_))
                    (bs-Resize null
                               null
                               (bm-constructor (b s 'bool const-chunk 'value)
                                               (cons-asgn 'value_ 'value)
                                               null)
                               (fc 'value)
                               (r-fcn-def (constize (fcn-dcl 'value
                                                             (b s 'bool const-chunk)))
                                          null
                                          'value_)
                                (b s 'bool const-chunk 'value_))
                    (bs-SeqWalk null
                                (bm-constructor (b s 'bool const-chunk 'value)
                                                (cons-asgn 'value_ 'value)
                                                null)
                                null
                                'false
                                'false
                                (r-fcn-def (constize (fcn-dcl 'eval
                                                              (b s 'bool const-chunk)))
                                          null
                                          'value_)
                                (b s 'bool const-chunk 'value_)))
      (build-struct NCF-chunk
                    #true
                    null
                    null
                    (bs-Initial null
                                null
                                null
                                (tpl-pmtr (scope (scope 'structured
                                                        (tpl-use 'FromGhost
                                                                 (tpl-pmtr (scope FT-chunk 'Ghost))
                                                                 (tpl-pmtr (scope (scope FT-chunk 'Location)
                                                                                  'BCExtra))))
                                                 'result))
                                (bm-constructor (b s FT-chunk const-chunk "&" 'f)
                                                (cons-asgn 'field_ 'f)
                                                null)
                                (mfc (fc 'field)
                                     (tpl-fcn-use 'resize_ghost_and_shift VG-chunk SH-chunk))
                                (mfc (fc 'field)
                                     (tpl-fcn-use 'resize_ghost_and_shift VG-chunk SH-chunk))
                                (r-fcn-def (constize (fcn-dcl 'field
                                                              (b s FT-chunk const-chunk "&")))
                                           null
                                           'field_)
                                (b s FT-chunk const-chunk 'field_))
                    (bs-ResizePrep null
                                   null
                                   (bm-constructor (b s FT-chunk const-chunk "&" 'f)
                                                   (cons-asgn 'field_ 'f)
                                                   null)
                                   (fc FT-chunk
                                       (mfc 'size
                                            (tpl-fcn-use 'shift SH-chunk))
                                       (mfc (fc 'field)
                                            'field_values)
                                       (scope 'structured 'ExternalStorage))
                                   (r-fcn-def (constize (fcn-dcl 'field
                                                                 (b s FT-chunk const-chunk "&")))
                                              null
                                              'field_)
                                   (b s FT-chunk const-chunk 'field_))
                    (bs-Resize null
                               null
                               (bm-constructor (b s FT-chunk const-chunk "&" 'f)
                                               (cons-asgn 'field_ 'f)
                                               null)
                               (fc 'field)
                               (r-fcn-def (constize (fcn-dcl 'field
                                                             (b s FT-chunk const-chunk "&")))
                                          null
                                          'field_)
                               (b s FT-chunk const-chunk 'field_))
                    (bs-SeqWalk (typedef (scope (tpl-pmtr FT-chunk)
                                                'value_type)
                                         'AtomicType)
                                (bm-constructor (b s FT-chunk const-chunk "&" 'f)
                                                (list (cons-asgn 'iter_
                                                                 (mfc 'f 'begin))
                                                      (cons-asgn 'end_
                                                                 (mfc 'f 'end)))
                                                null)
                                "++iter_"
                                "(iter_ == end_)"
                                'true
                                (r-fcn-def (constize (fcn-dcl 'eval
                                                              (b s 'AtomicType const-chunk "&")))
                                          null
                                          "*iter_")
                                (list (b s
                                         (tpl-pmtr (scope FT-chunk 'const_iterator))
                                         'iter_)
                                      (b s
                                         (tpl-pmtr (scope FT-chunk 'const_iterator))
                                         const-chunk
                                         'end_))))
      (build-struct NF-chunk
                    #false
                    null
                    null
                    (bs-Initial null
                                null
                                null
                                (tpl-pmtr (scope (scope 'structured
                                                        (tpl-use 'FromGhost
                                                                 (tpl-pmtr (scope FT-chunk 'Ghost))
                                                                 (tpl-pmtr (scope (scope FT-chunk 'Location)
                                                                                  'BCExtra))))
                                                 'result))
                                (bm-constructor (b s FT-chunk 'f)
                                                (cons-asgn 'field_ 'f)
                                                null)
                                (mfc (fc 'field)
                                     (tpl-fcn-use 'resize_ghost_and_shift VG-chunk SH-chunk))
                                (mfc (fc 'field)
                                     (tpl-fcn-use 'resize_ghost_and_shift VG-chunk SH-chunk))
                                (r-fcn-def (fcn-dcl 'field
                                                    (c FT-chunk s "&"))
                                           null
                                           'field_)
                                (b s FT-chunk 'field_))
                    (bs-ResizePrep null
                                   null
                                   (bm-constructor (b s FT-chunk 'f)
                                                   (cons-asgn 'field_ 'f)
                                                   null)
                                   (fc FT-chunk
                                       (mfc 'size
                                            (tpl-fcn-use 'shift SH-chunk))
                                       (mfc (fc 'field)
                                            'field_values)
                                       (scope 'structured 'ExternalStorage))
                                   (r-fcn-def (fcn-dcl 'field
                                                       (c FT-chunk s "&"))
                                              null
                                              'field_)
                                   (b s FT-chunk 'field_))
                    (bs-Resize null
                               null
                               (bm-constructor (b s FT-chunk 'f)
                                               (cons-asgn 'field_ 'f)
                                               null)
                               (fc 'field)
                               (r-fcn-def (fcn-dcl 'field
                                                   (c FT-chunk s "&"))
                                          null
                                          'field_)
                               (b s FT-chunk 'field_))
                    (bs-SeqWalk (typedef (scope (tpl-pmtr FT-chunk)
                                                'value_type)
                                         'AtomicType)
                                (bm-constructor (b s FT-chunk 'f)
                                                (list (cons-asgn 'iter_
                                                                 (mfc 'f 'begin))
                                                      (cons-asgn 'end_
                                                                 (mfc 'f 'end)))
                                                null)
                                "++iter_"
                                "(iter_ == end_)"
                                'true
                                (list (r-fcn-def (fcn-dcl 'ref
                                                          (c 'AtomicType s "&"))
                                                 null
                                                 "*iter_")
                                      (r-fcn-def (fcn-dcl 'ptr
                                                          (c 'AtomicType s "*"))
                                                 null
                                                 "&(*iter_)"))
                                (list (b s (tpl-pmtr (scope FT-chunk 'iterator))
                                         'iter_)
                                      (b s (tpl-pmtr (scope FT-chunk 'iterator))
                                         const-chunk
                                         'end_))))
      (tpl-srt-dcl 'Standardize
                   (list (tpl-pmtr 'Input)
                         (tpl-pmtr FT-chunk))
                   null)
      (tpl-srt-def 'Standardize
                   (tpl-pmtr FT-chunk)
                   (list FT-chunk FT-chunk)
                   (typedef (tpl-use NCF-chunk 'Initial FT-chunk)
                            'StandardType)
                   (typedef (tpl-use NE-chunk 'StandardType FT-chunk)
                            'StandardTerm)
                   (r-fcn-def (s-fcn-dcl 'standardType
                                         'StandardType
                                         (b s FT-chunk const-chunk "&" 'given))
                              null
                              (fc 'StandardType 'given))
                   (r-fcn-def (s-fcn-dcl 'standardTerm
                                         'StandardTerm
                                         (b s FT-chunk const-chunk "&" 'given))
                              null
                              (fc 'StandardTerm (fc 'StandardType 'given))))
      (tpl-srt-def 'Standardize
                   (list (tpl-pmtr 'ExprType)
                         (tpl-pmtr FT-chunk))
                   (list (tpl-use NE-chunk 'ExprType FT-chunk)
                         FT-chunk)
                   (typedef 'ExprType
                            'StandardType)
                   (typedef (tpl-use NE-chunk 'StandardType FT-chunk)
                            'StandardTerm)
                   (r-fcn-def (s-fcn-dcl 'standardType
                                         'StandardType
                                         (b s
                                            (tpl-use NE-chunk 'ExprType FT-chunk)
                                            const-chunk
                                            "&"
                                            'given))
                              null
                              (mfc 'given 'expr))
                   (r-fcn-def (s-fcn-dcl 'standardTerm
                                         'StandardTerm
                                         (b s
                                            (tpl-use NE-chunk 'ExprType FT-chunk)
                                            const-chunk
                                            "&"
                                            'given))
                              null
                              'given))
      (build-binary-operator 'SumOp
                             "+"
                             (c 'operator s "+"))
      (build-binary-operator 'DiffOp
                             "-"
                             (c 'operator s "-"))
      (build-binary-operator 'ProdOp
                             "*"
                             (c 'operator s "*"))
      (build-binary-operator 'DivOp
                             "/"
                             (c 'operator s "/"))
      (build-unary-function 'SinFcn
                            (scope 'std 'sin)
                            'sin)
      (build-unary-function 'CosFcn
                            (scope 'std 'cos)
                            'cos)
      (build-unary-function 'TanFcn
                            (scope 'std 'tan)
                            'tan)
      (build-unary-function 'ExpFcn
                            (scope 'std 'exp)
                            'exp)
      (build-unary-function 'TanhFcn
                            (scope 'std 'tanh)
                            'tanh)
      (build-unary-function 'AbsFcn
                            (scope 'std 'abs)
                            'abs)
      (build-unary-function 'NegFcn
                            "-"
                            (c 'operator s "-"))
      (build-binary-function 'PowFcn
                             (scope 'std 'pow)
                             'pow)
      (build-unary-function 'SqrtFcn
                            (scope 'std 'sqrt)
                            'sqrt)
      (build-unary-function 'LogFcn
                            (scope 'std 'log)
                            'log)
      (build-comparison-operator 'EqualCmp
                                 "=="
                                 (c 'operator s "=="))
      (build-comparison-operator 'InequalCmp
                                 "!="
                                 (c 'operator s "!="))
      (build-comparison-operator 'LessThanCmp
                                 "<"
                                 (c 'operator s "<"))
      (build-comparison-operator 'LessThanEqualCmp
                                 "<="
                                 (c 'operator s "<="))
      (build-comparison-operator 'GreaterThanCmp
                                 ">"
                                 (c 'operator s ">"))
      (build-comparison-operator 'GreaterThanEqualCmp
                                 ">="
                                 (c 'operator s ">="))
      (build-binary-logical-operator 'AndOp
                                     "&&"
                                     (c 'operator s "&&"))
      (build-binary-logical-operator 'OrOp
                                     "||"
                                     (c 'operator s "||"))
      (build-unary-logical-function 'NotOp
                                    "!"
                                    (c 'operator s "!"))
      (m 'BUILD_BINARY_FUNCTION
         (list 'OBJECT_NAME
               'INTERNAL_NAME
               'EXTERNAL_NAME)
         (build-binary-function 'OBJECT_NAME
                                'INTERNAL_NAME
                                'EXTERNAL_NAME))
      (m 'BUILD_BINARY_OPERATOR
         (list 'OBJECT_NAME
               'INTERNAL_NAME
               'EXTERNAL_NAME)
         (build-binary-operator 'OBJECT_NAME
                                'INTERNAL_NAME
                                'EXTERNAL_NAME))
      (m 'BUILD_UNARY_FUNCTION
         (list 'OBJECT_NAME
               'INTERNAL_NAME
               'EXTERNAL_NAME)
         (build-unary-function 'OBJECT_NAME
                               'INTERNAL_NAME
                               'EXTERNAL_NAME))
      (srt-def (srt-dcl Nil-chunk)
               (typedef (scope 'structured 'InfiniteGhostData) report-VG-chunk)
               (constructor-chunk Nil-chunk
                                  null
                                  null))
      (build-struct Clause-chunk
                    #true
                    (list (tpl-pmtr 'Test)
                          (tpl-pmtr 'Expr))
                    (list 'Test 'Expr)
                    (bs-Initial (list (tpl-pmtr (scope (scope 'Test
                                                              (tpl-fcn-use 'Iterator VG-chunk SH-chunk))
                                                       'ResizePrepType))
                                      (tpl-pmtr (scope (scope 'Expr
                                                              (tpl-fcn-use 'Iterator VG-chunk SH-chunk))
                                                       'ResizePrepType)))
                                (list (tpl-pmtr (scope (scope 'Test
                                                              (tpl-fcn-use 'Iterator VG-chunk SH-chunk))
                                                       'SeqWalkType))
                                      (tpl-pmtr (scope (scope 'Expr
                                                              (tpl-fcn-use 'Iterator VG-chunk SH-chunk))
                                                       'SeqWalkType)))
                                null
                                (tpl-pmtr (scope (scope 'structured
                                                        (tpl-use 'Minimum
                                                                 (tpl-pmtr (scope 'Test report-VG-chunk))
                                                                 (tpl-pmtr (scope 'Expr report-VG-chunk))))
                                                 'result))
                                (bm-constructor (list (b s 'Test const-chunk "&" 't)
                                                      (b s 'Expr const-chunk "&" 'e))
                                                (list (cons-asgn 'test_ 't)
                                                      (cons-asgn 'expr_ 'e))
                                                null)
                                (list (mfc (fc 'test)
                                           (tpl-fcn-use 'init VG-chunk SH-chunk))
                                      (mfc (fc 'expr)
                                           (tpl-fcn-use 'init VG-chunk SH-chunk)))
                                (list (mfc (fc 'test)
                                           (tpl-fcn-use 'resize_prep VG-chunk SH-chunk))
                                      (mfc (fc 'expr)
                                           (tpl-fcn-use 'resize_prep VG-chunk SH-chunk)))
                                (list (r-fcn-def (constize (fcn-dcl 'test
                                                                    (b s 'Test const-chunk "&")))
                                                 null
                                                 'test_)
                                      (r-fcn-def (constize (fcn-dcl 'expr
                                                                    (b s 'Expr const-chunk "&")))
                                                 null
                                                 'expr_))
                                (list (b s 'Test const-chunk 'test_)
                                      (b s 'Expr const-chunk 'expr_)))
                    (bs-ResizePrep (list (tpl-pmtr (scope 'Test 'ResizeType))
                                         (tpl-pmtr (scope 'Expr 'ResizeType)))
                                   null
                                   (bm-constructor (list (b s 'Test const-chunk "&" 'test)
                                                         (b s 'Expr const-chunk "&" 'expr))
                                                   (list (cons-asgn 'test_ 'test)
                                                         (cons-asgn 'expr_ 'expr))
                                                   null)
                                   (list (mfc (fc 'test)
                                              'resize
                                              'size
                                              'split
                                              'location)
                                         (mfc (fc 'expr)
                                              'resize
                                              'size
                                              'split
                                              'location))
                                   (list (r-fcn-def (constize (fcn-dcl 'test
                                                                       (b s 'Test const-chunk "&")))
                                                    null
                                                    'test_)
                                         (r-fcn-def (constize (fcn-dcl 'expr
                                                                       (b s 'Expr const-chunk "&")))
                                                    null
                                                    'expr_))
                                   (list (b s 'Test const-chunk 'test_)
                                         (b s 'Expr const-chunk 'expr_)))
                    (bs-Resize (list (tpl-pmtr (scope 'Test 'SeqWalkType))
                                     (tpl-pmtr (scope 'Expr 'SeqWalkType)))
                               null
                               (bm-constructor (list (b s 'Test const-chunk "&" 'test)
                                                     (b s 'Expr const-chunk "&" 'expr))
                                               (list (cons-asgn 'test_ 'test)
                                                     (cons-asgn 'expr_ 'expr))
                                               null)
                               (list (mfc (fc 'test)
                                          'init)
                                     (mfc (fc 'expr)
                                          'init))
                               (list (r-fcn-def (constize (fcn-dcl 'test
                                                                   (b s 'Test const-chunk "&")))
                                          null
                                          'test_)
                                     (r-fcn-def (constize (fcn-dcl 'expr
                                                                   (b s 'Expr const-chunk "&")))
                                          null
                                          'expr_))
                               (list (b s 'Test const-chunk 'test_)
                                     (b s 'Expr const-chunk 'expr_)))
                    (bs-SeqWalk (typedef (scope (tpl-pmtr FT-chunk)
                                                'value_type)
                                         'AtomicType)
                                (bm-constructor (list (b s 'Test const-chunk "&" 'test)
                                                      (b s 'Expr const-chunk "&" 'expr))
                                                (list (cons-asgn 'test_ 'test)
                                                      (cons-asgn 'expr_ 'expr))
                                                null)
                                (c (mfc 'test_ 'next)
                                   semi-colon-chunk s
                                   (mfc 'expr_ 'next))
                                (p (c (mfc 'test_ 'at_end)
                                      s "||" s
                                      (mfc 'expr_ 'at_end)))
                                (p (c (mfc 'test_ 'has_length)
                                      s "||" s
                                      (mfc 'expr_ 'has_length)))
                                (list (r-fcn-def (constize (fcn-dcl 'check
                                                                    (b s 'bool const-chunk)))
                                          null
                                          (mfc 'test_ 'eval))
                                      (r-fcn-def (constize (fcn-dcl 'eval
                                                                    (b s 'AtomicType const-chunk)))
                                          null
                                          (mfc 'expr_ 'eval)))
                                (list (c 'Test s 'test_)
                                      (c 'Expr s 'expr_))))
      (build-struct Cond-chunk
                    #true
                    (list (tpl-pmtr CT-chunk)
                          (tpl-pmtr 'Otherwise))
                    (list CT-chunk 'Otherwise)
                    (bs-Initial (list (tpl-pmtr (scope (scope CT-chunk
                                                              (tpl-fcn-use 'Iterator VG-chunk SH-chunk))
                                                       'ResizePrepType))
                                      (tpl-pmtr (scope (scope 'Otherwise
                                                              (tpl-fcn-use 'Iterator VG-chunk SH-chunk))
                                                       'ResizePrepType)))
                                (list (tpl-pmtr (scope (scope CT-chunk
                                                              (tpl-fcn-use 'Iterator VG-chunk SH-chunk))
                                                       'SeqWalkType))
                                      (tpl-pmtr (scope (scope 'Otherwise
                                                              (tpl-fcn-use 'Iterator VG-chunk SH-chunk))
                                                       'SeqWalkType)))
                                null
                                (tpl-pmtr (scope (scope 'structured (tpl-use 'Minimum
                                                                             (tpl-pmtr (scope CT-chunk report-VG-chunk))
                                                                             (tpl-pmtr (scope 'Otherwise report-VG-chunk))))
                                                 'result))
                                (bm-constructor (list (b s CT-chunk const-chunk "&" 'c)
                                                      (b s 'Otherwise const-chunk "&" 'e))
                                                (list (cons-asgn 'clause_ 'c)
                                                      (cons-asgn 'otherwise_ 'e))
                                                null)
                                (list (mfc (fc 'clause)
                                           (tpl-fcn-use 'init VG-chunk SH-chunk))
                                      (mfc (fc 'otherwise)
                                           (tpl-fcn-use 'init VG-chunk SH-chunk)))
                                (list (mfc (fc 'clause)
                                           (tpl-fcn-use 'resize_prep VG-chunk SH-chunk))
                                      (mfc (fc 'otherwise)
                                           (tpl-fcn-use 'resize_prep VG-chunk SH-chunk)))
                                (list (r-fcn-def (constize (fcn-dcl 'clause
                                                                    (b s CT-chunk const-chunk "&")))
                                                 null
                                                 'clause_)
                                      (r-fcn-def (constize (fcn-dcl 'otherwise
                                                                    (b s 'Otherwise const-chunk "&")))
                                                 null
                                                 'otherwise_))
                                (list (b s CT-chunk const-chunk 'clause_)
                                      (b s 'Otherwise const-chunk 'otherwise_)))
                    (bs-ResizePrep (list (tpl-pmtr (scope CT-chunk 'ResizeType))
                                         (tpl-pmtr (scope 'Otherwise 'ResizeType)))
                                   null
                                   (bm-constructor (list (b s CT-chunk const-chunk "&" 'clause)
                                                         (b s 'Otherwise const-chunk "&" 'otherwise))
                                                   (list (cons-asgn 'clause_ 'clause)
                                                         (cons-asgn 'otherwise_ 'otherwise))
                                                   null)
                                   (list (mfc (fc 'clause)
                                              'resize
                                              'size
                                              'split
                                              'location)
                                         (mfc (fc 'otherwise)
                                              'resize
                                              'size
                                              'split
                                              'location))
                                   (list (r-fcn-def (constize (fcn-dcl 'clause
                                                                       (b s CT-chunk const-chunk "&")))
                                                    null
                                                    'clause_)
                                         (r-fcn-def (constize (fcn-dcl 'otherwise
                                                                       (b s 'Otherwise const-chunk "&")))
                                                    null
                                                    'otherwise_))
                                   (list (b s CT-chunk const-chunk 'clause_)
                                         (b s 'Otherwise const-chunk 'otherwise_)))
                    (bs-Resize (list (tpl-pmtr (scope CT-chunk 'SeqWalkType))
                                     (tpl-pmtr (scope 'Otherwise 'SeqWalkType)))
                               null
                               (bm-constructor (list (b s CT-chunk const-chunk "&" 'clause)
                                                     (b s 'Otherwise const-chunk "&" 'otherwise))
                                               (list (cons-asgn 'clause_ 'clause)
                                                     (cons-asgn 'otherwise_ 'otherwise))
                                               null)
                               (list (mfc (fc 'clause)
                                          'init)
                                     (mfc (fc 'otherwise)
                                          'init))
                               (list (r-fcn-def (constize (fcn-dcl 'clause
                                                                   (b s CT-chunk const-chunk "&")))
                                          null
                                          'clause_)
                                     (r-fcn-def (constize (fcn-dcl 'otherwise
                                                                   (b s 'Otherwise const-chunk "&")))
                                          null
                                          'otherwise_))
                               (list (b s CT-chunk const-chunk 'clause_)
                                     (b s 'Otherwise const-chunk 'otherwise_)))
                    (bs-SeqWalk (typedef (scope (tpl-pmtr FT-chunk)
                                                'value_type)
                                         'AtomicType)
                                (bm-constructor (list (b s CT-chunk const-chunk "&" 'clause)
                                                      (b s 'Otherwise const-chunk "&" 'otherwise))
                                                (list (cons-asgn 'clause_ 'clause)
                                                      (cons-asgn 'otherwise_ 'otherwise))
                                                null)
                                (c (mfc 'clause_ 'next)
                                   semi-colon-chunk s
                                   (mfc 'otherwise_ 'next))
                                (p (c (mfc 'clause_ 'at_end)
                                      s "||" s
                                      (mfc 'otherwise_ 'at_end)))
                                (p (c (mfc 'clause_ 'has_length)
                                      s "||" s
                                      (mfc 'otherwise_ 'has_length)))
                                (r-fcn-def (constize (fcn-dcl 'eval
                                                              (b s 'AtomicType const-chunk)))
                                           null
                                           (b s
                                              (mfc 'clause_ 'check)
                                              "?"
                                              (mfc 'clause_ 'eval)
                                              colon-chunk
                                              (mfc 'otherwise_ 'eval)))
                                (list (c CT-chunk s 'clause_)
                                      (c 'Otherwise s 'otherwise_))))
      (srt-def (srt-dcl SClause-chunk)
               (sec-def public-chunk
                        (constructor-chunk SClause-chunk
                                           (list (c 'bool s 'b)
                                                 (c 'double s 'd))
                                           (list (cons-asgn 'b_ 'b)
                                                 (cons-asgn 'd_ 'd)))
                        (r-fcn-def (constize (fcn-dcl 'check
                                                      'bool))
                                   null
                                   'b_)
                        (r-fcn-def (constize (fcn-dcl 'eval
                                                      'double))
                                   null
                                   'd_)
                        (tpl-srt-def 'Convert
                                     (tpl-pmtr FT-chunk)
                                     null
                                     (typedef (tpl-use NB-chunk 'Initial FT-chunk)
                                              'Boolean)
                                     (typedef (tpl-use NS-chunk 'Initial FT-chunk)
                                              'Scalar)
                                     (typedef (tpl-use Clause-chunk 'Initial 'Boolean 'Scalar FT-chunk)
                                              'Converted)
                                     (r-fcn-def (s-fcn-dcl 'convert
                                                           'Converted
                                                           (list (c 'bool s 'b)
                                                                 (c 'double s 'd)))
                                                null
                                                (fc 'Converted
                                                    (fc 'Boolean 'b)
                                                    (fc 'Scalar 'd)))))
               (sec-def private-chunk
                        (b s 'bool const-chunk 'b_)
                        (b s 'double const-chunk 'd_)))
      (srt-def (srt-dcl SFClause-chunk)
               (sec-def public-chunk
                        (constructor-chunk SFClause-chunk
                                           (c 'double s 'd)
                                           (cons-asgn 'd_ 'd))
                        (r-fcn-def (constize (fcn-dcl 'eval
                                                      'double))
                                   null
                                   'd_))
               (sec-def private-chunk
                        (b s 'double const-chunk 'd_)))
      (tpl-srt-def SCond-chunk
                   (tpl-pmtr 'Otherwise)
                   null
                   (sec-def public-chunk
                            (constructor-chunk SCond-chunk
                                               (list (c SClause-chunk s 'c)
                                                     (c 'Otherwise s 'otherwise))
                                               (list (cons-asgn 'c_ 'c)
                                                     (cons-asgn 'otherwise_ 'otherwise)))
                            (r-fcn-def (constize (fcn-dcl 'eval
                                                          'double
                                                          null))
                                       null
                                       (b s
                                          (mfc 'c_ 'check)
                                          "?"
                                          (mfc 'c_ 'eval)
                                          colon-chunk
                                          (mfc 'otherwise_ 'eval)))
                            (tpl-srt-def 'Convert
                                         (tpl-pmtr FT-chunk)
                                         null
                                         (typedef (scope SClause-chunk
                                                         (tpl-fcn-use 'Convert FT-chunk))
                                                  'ConvertingClause)
                                         (typedef (tpl-pmtr (scope 'ConvertingClause
                                                                   'Converted))
                                                  'ConvertedClause)
                                         (typedef (tpl-pmtr (scope 'Otherwise
                                                                   (tpl-fcn-use 'Convert FT-chunk)))
                                                  'ConvertingList)
                                         (typedef (tpl-pmtr (scope 'ConvertingList 'Converted))
                                                  'ConvertedList)
                                         (typedef (tpl-use Cond-chunk 'Initial 'ConvertedClause 'ConvertedList FT-chunk)
                                                  'Converted)
                                         (r-fcn-def (s-fcn-dcl 'convert
                                                               'Converted
                                                               (list (c SClause-chunk s 'c)
                                                                     (c 'Otherwise s 'o)))
                                                    null
                                                    (fc 'Converted
                                                        (fc (scope 'ConvertingClause 'convert)
                                                            (mfc 'c 'check)
                                                            (mfc 'c 'eval))
                                                        (mfc 'o (tpl-fcn-use 'convert FT-chunk)))))
                            (tpl-def (tpl-pmtr FT-chunk)
                                     (r-fcn-def (constize (fcn-dcl 'convert
                                                                   (tpl-pmtr (scope (tpl-use 'Convert FT-chunk)
                                                                                    'Converted))))
                                                (typedef (tpl-use 'Convert FT-chunk)
                                                         'Convert)
                                                (fc (scope 'Convert 'convert)
                                                    (fc 'clause)
                                                    (fc 'otherwise))))
                            (r-fcn-def (constize (fcn-dcl 'clause
                                                          (b s SClause-chunk const-chunk "&")))
                                       null
                                       'c_)
                            (r-fcn-def (constize (fcn-dcl 'otherwise
                                                          (b s 'Otherwise const-chunk "&")))
                                       null
                                       'otherwise_))
                   (sec-def private-chunk
                            (b s SClause-chunk const-chunk 'c_)
                            (b s 'Otherwise const-chunk 'otherwise_)))
      (tpl-srt-def SCond-chunk
                   null
                   Nil-chunk
                   (sec-def public-chunk
                            (constructor-chunk SCond-chunk
                                               (list (c SClause-chunk s 'c)
                                                     (c Nil-chunk s 'nil))
                                               (cons-asgn 'c_ 'c))
                            (tpl-srt-def 'Convert
                                         (tpl-pmtr FT-chunk)
                                         null
                                         (typedef (scope SClause-chunk
                                                         (tpl-fcn-use 'Convert FT-chunk))
                                                  'ConvertingClause)
                                         (typedef (tpl-pmtr (scope 'ConvertingClause 'Converted))
                                                  'ConvertedClause)
                                         (typedef Nil-chunk
                                                  'ConvertedList)
                                         (typedef (tpl-use Cond-chunk
                                                           'Initial
                                                           'ConvertedClause
                                                           'ConvertedList
                                                           FT-chunk)
                                                  'Converted)
                                         (r-fcn-def (s-fcn-dcl 'convert
                                                               'Converted
                                                               (c SClause-chunk s 'c))
                                                    null
                                                    (fc 'Converted
                                                        (fc (scope 'ConvertingClause 'convert)
                                                            (mfc 'c 'check)
                                                            (mfc 'c 'eval))
                                                        (fc Nil-chunk))))
                            (tpl-def (tpl-pmtr FT-chunk)
                                     (r-fcn-def (constize (fcn-dcl 'convert
                                                                   (tpl-pmtr (scope (tpl-use 'Convert FT-chunk)
                                                                                    'Converted))))
                                                (typedef (tpl-use 'Convert FT-chunk)
                                                         'Convert)
                                                (fc (scope 'Convert 'convert)
                                                    (fc 'clause))))
                            (r-fcn-def (constize (fcn-dcl 'clause
                                                          (b s SClause-chunk const-chunk "&")))
                                       null
                                       'c_)
                            (r-fcn-def (constize (fcn-dcl 'otherwise Nil-chunk))
                                       null
                                       (fc Nil-chunk)))
                   (sec-def private-chunk
                            (b s SClause-chunk const-chunk 'c_)))
      ;CondBuilder
      (let* ([build-CondBuilder-private
              (lambda (extra-tpl-pmtrs
                       remaining-type
                       new-result-type
                       private)
                (sec-def private-chunk
                         (tpl-srt-dcl 'ReverseListRecursive
                                      (list (tpl-pmtr 'Remaining)
                                            (tpl-pmtr 'PreceedingResult)))
                         (tpl-srt-def 'ReverseListRecursive
                                      (tpl-pmtr 'PreceedingResult)
                                      (list Nil-chunk 'PreceedingResult)
                                      (typedef 'PreceedingResult
                                               'Result)
                                      (r-fcn-def (s-fcn-dcl 'reverse
                                                            'Result
                                                            (c Nil-chunk s 'nil)
                                                            (c 'PreceedingResult s 'r))
                                                 null
                                                 'r))
                         (tpl-srt-def 'ReverseListRecursive
                                      (list extra-tpl-pmtrs
                                            (tpl-pmtr 'Following)
                                            (tpl-pmtr 'PreceedingResult))
                                      (list remaining-type
                                            'PreceedingResult)
                                      (typedef remaining-type
                                               'Remaining)
                                      (typedef new-result-type
                                               'NewResult)
                                      (typedef (tpl-use 'ReverseListRecursive 'Following 'NewResult)
                                               'InternalCall)
                                      (typedef (tpl-pmtr (scope 'InternalCall 'Result))
                                               'Result)
                                      (r-fcn-def (s-fcn-dcl 'reverse
                                                            'Result
                                                            (c 'Remaining s 'l)
                                                            (c 'PreceedingResult s 'r))
                                                 null
                                                 (fc (scope 'InternalCall 'reverse)
                                                     (mfc 'l 'otherwise)
                                                     (fc 'NewResult
                                                         (mfc 'l 'clause)
                                                         'r))))
                         private))]
             [build-CondBuilder-public
              (lambda (tpl-pmtrs
                       tpl-args
                       construct-args
                       construct-asgns
                       public)
                (sec-def public-chunk
                         (constructor-chunk 'CondBuilder
                                            construct-args
                                            construct-asgns)
                         (tpl-srt-dcl 'ReverseList
                                      (tpl-pmtr 'Final))
                         (tpl-srt-def 'ReverseList
                                      (tpl-pmtr 'Final)
                                      null
                                      (typedef  (tpl-use 'ReverseListRecursive 'List 'Final)
                                                'InternalCall)
                                      (typedef  (tpl-pmtr (scope 'InternalCall 'Result))
                                                'Result)
                                      (r-fcn-def (s-fcn-dcl 'reverse
                                                            'Result
                                                            (c 'List s 'l)
                                                            (c 'Final s 'f))
                                                 null
                                                 (fc (scope 'InternalCall 'reverse)
                                                     'l
                                                     'f)))
                         (tpl-def (tpl-pmtr 'Final)
                                  (r-fcn-def (fcn-dcl 'reverse
                                                      (tpl-pmtr (scope (tpl-use 'ReverseList 'Final)
                                                                       'Result))
                                                      (c 'Final s 'f))
                                             (typedef (tpl-use 'ReverseList 'Final)
                                                      'InternalCall)
                                             (fc (scope 'InternalCall 'reverse)
                                                 'list_
                                                 'f)))
                         public))]
             [build-CondBuilder
              (lambda (extra-tpl-pmtrs
                       remaining-type
                       new-result-type
                       tpl-pmtrs
                       tpl-args
                       private
                       construct-args
                       construct-asgns
                       public)
                (tpl-srt-def 'CondBuilder
                             (let ([tpl-pmtrs (flatten* tpl-pmtrs)])
                               (cond [(null? tpl-pmtrs) null]
                                     [(pair? tpl-pmtrs) (map tpl-pmtr tpl-pmtrs)]
                                     [else (tpl-pmtr tpl-pmtrs)]))
                             tpl-args
                             (sec-def 'public
                                      (typedef tpl-args
                                               'List))
                             (build-CondBuilder-private extra-tpl-pmtrs
                                                        remaining-type
                                                        new-result-type
                                                        private)
                             (build-CondBuilder-public tpl-pmtrs
                                                       tpl-args
                                                       construct-args
                                                       construct-asgns
                                                       public)))]
             [end-val ; end case - given scalar value
              (lambda (name
                       return-type
                       internals
                       return-expr)
                (r-fcn-def (fcn-dcl name
                                    return-type
                                    (c 'double s 'd))
                           internals
                           return-expr))]
             [end-expr ; end case - given expression
              (lambda (name
                       return-type
                       internals
                       return-expr)
                (tpl-def (tpl-pmtr 'Expr)
                         (r-fcn-def (fcn-dcl name
                                             return-type
                                             (c 'Expr s 'e))
                                    internals
                                    return-expr)))]
             [cond-bool-val ; conditional case - given a boolean value and a scalar value
              (lambda (name
                       return-type
                       internals
                       return-expr)
                (r-fcn-def (fcn-dcl name
                                    return-type
                                    (list (c 'bool s 'b)
                                          (c 'double s 'd)))
                           internals
                           return-expr))]
             [cond-bool-expr ; conditional case - given a boolean value and an expression
              (lambda (name
                       return-type
                       internals
                       return-expr)
                (tpl-def (tpl-pmtr 'Expr)
                         (r-fcn-def (fcn-dcl name
                                             return-type
                                             (list (c 'bool s 'b)
                                                   (c 'Expr s 'e)))
                                    internals
                                    return-expr)))]
             [cond-NBE-val ; conditional case - given a boolean expression and a scalar value
              (lambda (name
                       FT-defined?
                       return-type
                       internals
                       return-expr)
                (tpl-def (if FT-defined?
                             (tpl-pmtr 'BoolExpr)
                             (list (tpl-pmtr 'BoolExpr)
                                   (tpl-pmtr FT-chunk)))
                         (r-fcn-def (fcn-dcl name
                                             return-type
                                             (list (c (tpl-use NBE-chunk 'BoolExpr FT-chunk) s 'nb)
                                                   (c 'double s 'd)))
                                    internals
                                    return-expr)))]
             [cond-NBE-expr ; conditional case - given a boolean expression and an expression
              (lambda (name
                       return-type
                       internals
                       return-expr)
                (tpl-def (list (tpl-pmtr 'BoolExpr)
                               (tpl-pmtr 'Expr))
                         (r-fcn-def (fcn-dcl name
                                             return-type
                                             (list (b s
                                                      (tpl-use NBE-chunk
                                                               'BoolExpr
                                                               (tpl-pmtr (scope 'Expr 'field_type)))
                                                      'nb)
                                                   (c 'Expr s 'e)))
                                    internals
                                    return-expr)))])
        (list (tpl-srt-dcl 'CondBuilder
                           (tpl-pmtr 'List))
                                        ; FT
              (build-CondBuilder (list (tpl-pmtr 'Next) (tpl-pmtr 'Field))
                                 (tpl-use Cond-chunk 'Initial 'Next 'Following 'Field)
                                 (tpl-use Cond-chunk 'Initial 'Next 'PreceedingResult 'Field)
                                 (list CT-chunk 'Otherwise FT-chunk)
                                 (c (tpl-use Cond-chunk 'Initial CT-chunk 'Otherwise FT-chunk) s)
                                 (c 'List s 'list_)
                                 (c (tpl-use Cond-chunk 'Initial CT-chunk 'Otherwise FT-chunk) s 'l)
                                 (cons-asgn 'list_ 'l)
                                 (list (end-val (c 'operator s (p))
                                                (tpl-use NE-chunk
                                                         (tpl-pmtr (scope (tpl-use 'ReverseList
                                                                                   (c (tpl-use NS-chunk 'Initial FT-chunk) s))
                                                                          'Result))
                                                         FT-chunk)
                                                (list (typedef (tpl-use NS-chunk 'Initial FT-chunk)
                                                               'Scalar)
                                                      (typedef (tpl-use 'ReverseList 'Scalar)
                                                               'Reverser)
                                                      (typedef (tpl-pmtr (scope 'Reverser 'Result))
                                                               'Reversed)
                                                      (typedef (tpl-use NE-chunk 'Reversed FT-chunk)
                                                               'Result))
                                                (fc 'Result (fc 'reverse (fc 'Scalar 'd))))
                                       (end-expr (c 'operator s (p))
                                                 (tpl-use NE-chunk
                                                          (tpl-pmtr (scope (tpl-use 'ReverseList
                                                                                    (tpl-pmtr (scope (tpl-use 'Standardize
                                                                                                              'Expr
                                                                                                              FT-chunk)
                                                                                                     'StandardType)))
                                                                           'Result))
                                                          FT-chunk)
                                                 (list (typedef (tpl-use 'Standardize 'Expr FT-chunk)
                                                                'Standardize)
                                                       (typedef (tpl-pmtr (scope 'Standardize 'StandardType))
                                                                'FinalType)
                                                       (typedef (tpl-use 'ReverseList 'FinalType)
                                                                'Reverser)
                                                       (typedef (tpl-pmtr (scope 'Reverser 'Result))
                                                                'Reversed)
                                                       (typedef (tpl-use NE-chunk 'Reversed FT-chunk)
                                                                'Result))
                                                 (fc 'Result
                                                     (fc 'reverse
                                                         (fc (scope 'Standardize 'standardType)
                                                             'e))))
                                       (cond-bool-val (c 'operator s (p))
                                                      (tpl-use 'CondBuilder (c (tpl-use Cond-chunk
                                                                                        'Initial
                                                                                        (tpl-use Clause-chunk
                                                                                                 'Initial
                                                                                                 (tpl-use NB-chunk 'Initial FT-chunk)
                                                                                                 (tpl-use NS-chunk 'Initial FT-chunk)
                                                                                                 FT-chunk)
                                                                                        'List
                                                                                        FT-chunk) s))
                                                      (list (typedef (tpl-use NB-chunk 'Initial FT-chunk)
                                                                     'Boolean)
                                                            (typedef (tpl-use NS-chunk 'Initial FT-chunk)
                                                                     'Scalar)
                                                            (typedef (tpl-use Clause-chunk 'Initial 'Boolean 'Scalar FT-chunk)
                                                                     'NewClause)
                                                            (typedef (tpl-use Cond-chunk 'Initial 'NewClause 'List FT-chunk)
                                                                     'Cond)
                                                            (typedef (tpl-use 'CondBuilder 'Cond)
                                                                     'ReturnType))
                                                      (fc 'ReturnType
                                                          (fc 'Cond
                                                              (fc 'NewClause
                                                                  (fc 'Boolean 'b)
                                                                  (fc 'Scalar 'd))
                                                              'list_)))
                                       (cond-bool-expr (c 'operator s (p))
                                                       (tpl-use 'CondBuilder (c (tpl-use Cond-chunk
                                                                                         'Initial
                                                                                         (tpl-use Clause-chunk
                                                                                                  'Initial
                                                                                                  (tpl-use NB-chunk 'Initial FT-chunk)
                                                                                                  (tpl-pmtr (scope (tpl-use 'Standardize 'Expr FT-chunk)
                                                                                                                   'StandardType))
                                                                                                  FT-chunk)
                                                                                         'List
                                                                                         FT-chunk) s))
                                                       (list (typedef (tpl-use NB-chunk 'Initial FT-chunk)
                                                                      'Boolean)
                                                             (typedef (tpl-use 'Standardize 'Expr FT-chunk)
                                                                      'Standardize)
                                                             (typedef (tpl-pmtr (scope 'Standardize 'StandardType))
                                                                      'StandardType)
                                                             (typedef (tpl-use Clause-chunk 'Initial 'Boolean 'StandardType FT-chunk)
                                                                      'Clause)
                                                             (typedef (tpl-use Cond-chunk 'Initial 'Clause 'List FT-chunk)
                                                                      'Cond)
                                                             (typedef (tpl-use 'CondBuilder 'Cond)
                                                                      'ReturnType))
                                                       (fc 'ReturnType
                                                           (fc 'Cond
                                                               (fc 'Clause
                                                                   (fc 'Boolean 'b)
                                                                   (fc (scope 'Standardize 'standardType)
                                                                       'e))
                                                               'list_)))
                                       (cond-NBE-val (c 'operator s (p))
                                                     #true
                                                     (tpl-use 'CondBuilder (c (tpl-use Cond-chunk
                                                                                       'Initial
                                                                                       (tpl-use Clause-chunk
                                                                                                'Initial
                                                                                                'BoolExpr
                                                                                                (tpl-use NS-chunk 'Initial FT-chunk)
                                                                                                FT-chunk)
                                                                                       'List
                                                                                       FT-chunk) s))
                                                     (list (typedef (tpl-use NS-chunk 'Initial FT-chunk)
                                                                    'Scalar)
                                                           (typedef (tpl-use Clause-chunk 'Initial 'BoolExpr 'Scalar FT-chunk)
                                                                    'NewClause)
                                                           (typedef (tpl-use Cond-chunk 'Initial 'NewClause 'List FT-chunk)
                                                                    'Cond)
                                                           (typedef (tpl-use 'CondBuilder 'Cond)
                                                                    'ReturnType))
                                                     (fc 'ReturnType
                                                         (fc 'Cond
                                                             (fc 'NewClause
                                                                 (mfc 'nb 'expr)
                                                                 (fc 'Scalar 'd))
                                                             'list_)))
                                       (cond-NBE-expr (c 'operator s (p))
                                                      (tpl-use 'CondBuilder (c (tpl-use Cond-chunk
                                                                                        'Initial
                                                                                        (tpl-use Clause-chunk
                                                                                                 'Initial
                                                                                                 'BoolExpr
                                                                                                 (tpl-pmtr (scope (tpl-use 'Standardize 'Expr FT-chunk) 'StandardType))
                                                                                                 FT-chunk)
                                                                                        'List
                                                                                        FT-chunk) s))
                                                      (list (typedef (tpl-use 'Standardize 'Expr FT-chunk)
                                                                     'Standardize)
                                                            (typedef (tpl-pmtr (scope 'Standardize 'StandardType))
                                                                     'StandardType)
                                                            (typedef (tpl-use Clause-chunk 'Initial 'BoolExpr 'StandardType FT-chunk)
                                                                     'Clause)
                                                            (typedef (tpl-use Cond-chunk 'Initial 'Clause 'List FT-chunk)
                                                                     'Cond)
                                                            (typedef (tpl-use 'CondBuilder 'Cond)
                                                                     'ReturnType))
                                                      (fc 'ReturnType
                                                          (fc 'Cond
                                                              (fc 'Clause
                                                                  (mfc 'nb 'expr)
                                                                  (fc (scope 'Standardize 'standardType)
                                                                      'e))
                                                              'list_)))))
                                        ; no FT
              (build-CondBuilder null
                                 (tpl-use SCond-chunk 'Following)
                                 (tpl-use SCond-chunk 'PreceedingResult)
                                 'Otherwise
                                 (c (tpl-use SCond-chunk 'Otherwise) s)
                                 (c 'List s 'list_)
                                 (c (tpl-use SCond-chunk 'Otherwise) s 'l)
                                 (cons-asgn 'list_ 'l)
                                 (list (end-val (c 'operator s (p))
                                                'double
                                                null
                                                (mfc (fc 'reverse (fc SFClause-chunk 'd))
                                                     'eval))
                                       (end-expr (c 'operator s (p))
                                                 (tpl-use NE-chunk
                                                          (tpl-pmtr (scope (scope (tpl-use 'CondBuilder
                                                                                           (tpl-pmtr (scope (scope 'List
                                                                                                                   (tpl-fcn-use 'Convert (tpl-pmtr (scope 'Expr 'field_type))))
                                                                                                            'Converted)))
                                                                                  (tpl-fcn-use 'ReverseList
                                                                                               (tpl-pmtr (scope (tpl-use 'Standardize
                                                                                                                         'Expr
                                                                                                                         (tpl-pmtr (scope 'Expr 'field_type)))
                                                                                                                'StandardType))))
                                                                           'Result))
                                                          (tpl-pmtr (scope 'Expr 'field_type)))
                                                 (list (typedef (tpl-pmtr (scope 'Expr 'field_type))
                                                                FT-chunk)
                                                       (typedef (tpl-pmtr (scope (scope 'List (tpl-fcn-use 'Convert (tpl-pmtr (scope 'Expr 'field_type))))
                                                                                 'Converted))
                                                                'Converted)
                                                       (typedef (tpl-use 'CondBuilder 'Converted)
                                                                'NewCondBuilder))
                                                 (fc (fc 'NewCondBuilder
                                                         (mfc 'list_ (tpl-fcn-use 'convert FT-chunk)))
                                                     'e))
                                       (cond-bool-val (c 'operator s (p))
                                                      (tpl-use 'CondBuilder (c (tpl-use SCond-chunk 'List) s))
                                                      (list (typedef (tpl-use SCond-chunk 'List)
                                                                     'Cond)
                                                            (typedef (tpl-use 'CondBuilder 'Cond)
                                                                     'ReturnType))
                                                      (fc 'ReturnType
                                                          (fc 'Cond
                                                              (fc SClause-chunk 'b 'd)
                                                              'list_)))
                                       (cond-bool-expr (c 'operator s (p))
                                                       (tpl-use 'CondBuilder (c (tpl-use Cond-chunk
                                                                                         'Initial
                                                                                         (tpl-use Clause-chunk
                                                                                                  'Initial
                                                                                                  (tpl-use NB-chunk 'Initial (tpl-pmtr (scope 'Expr 'field_type)))
                                                                                                  (tpl-pmtr (scope (tpl-use 'Standardize 'Expr (tpl-pmtr (scope 'Expr 'field_type)))
                                                                                                                   'StandardType))
                                                                                                  (tpl-pmtr (scope 'Expr 'field_type)))
                                                                                         (tpl-pmtr (scope (scope 'List (tpl-fcn-use 'Convert (tpl-pmtr (scope 'Expr 'field_type))))
                                                                                                          'Converted))
                                                                                         (tpl-pmtr (scope 'Expr 'field_type)))
                                                                                s))
                                                       (list (typedef (tpl-pmtr (scope 'Expr 'field_type))
                                                                      FT-chunk)
                                                             (typedef (tpl-use NB-chunk 'Initial FT-chunk)
                                                                      'Boolean)
                                                             (typedef (tpl-use 'Standardize 'Expr FT-chunk)
                                                                      'Standardize)
                                                             (typedef (tpl-pmtr (scope 'Standardize 'StandardType))
                                                                      'StandardType)
                                                             (typedef (tpl-use Clause-chunk 'Initial 'Boolean 'StandardType FT-chunk)
                                                                      'Clause)
                                                             (typedef (tpl-pmtr (scope (scope 'List (tpl-fcn-use 'Convert (tpl-pmtr (scope 'Expr 'field_type))))
                                                                                       'Converted))
                                                                      'Previous)
                                                             (typedef (tpl-use Cond-chunk 'Initial 'Clause 'Previous FT-chunk)
                                                                      'Cond)
                                                             (typedef (tpl-use 'CondBuilder 'Cond)
                                                                      'ReturnType))
                                                       (fc 'ReturnType
                                                           (fc 'Cond
                                                               (fc 'Clause
                                                                   (fc 'Boolean 'b)
                                                                   (fc (scope 'Standardize 'standardType)
                                                                       'e))
                                                               (mfc 'list_ (tpl-fcn-use 'convert FT-chunk)))))
                                       (cond-NBE-val (c 'operator s (p))
                                                     #false
                                                     (tpl-use 'CondBuilder (c (tpl-use Cond-chunk
                                                                                       'Initial
                                                                                       (tpl-use Clause-chunk
                                                                                                'Initial
                                                                                                'BoolExpr
                                                                                                (tpl-use NS-chunk 'Initial FT-chunk)
                                                                                                FT-chunk)
                                                                                       (tpl-pmtr (scope (scope 'List (tpl-fcn-use 'Convert FT-chunk))
                                                                                                        'Converted))
                                                                                       FT-chunk) s))
                                                     (list (typedef (tpl-use NS-chunk 'Initial FT-chunk)
                                                                    'Scalar)
                                                           (typedef (tpl-use Clause-chunk 'Initial 'BoolExpr 'Scalar FT-chunk)
                                                                    'Clause)
                                                           (typedef (tpl-pmtr (scope (scope 'List (tpl-fcn-use 'Convert FT-chunk))
                                                                                     'Converted))
                                                                    'Previous)
                                                           (typedef (tpl-use Cond-chunk 'Initial 'Clause 'Previous FT-chunk)
                                                                    'Cond)
                                                           (typedef (tpl-use 'CondBuilder 'Cond)
                                                                    'ReturnType))
                                                     (fc 'ReturnType
                                                         (fc 'Cond
                                                             (fc 'Clause
                                                                 (mfc 'nb 'expr)
                                                                 (fc 'Scalar 'd))
                                                             (mfc 'list_ (tpl-fcn-use 'convert FT-chunk)))))
                                       (cond-NBE-expr (c 'operator s (p))
                                                      (tpl-use 'CondBuilder (c (tpl-use Cond-chunk
                                                                                        'Initial
                                                                                        (tpl-use Clause-chunk
                                                                                                 'Initial
                                                                                                 'BoolExpr
                                                                                                 (tpl-pmtr (scope (tpl-use 'Standardize 'Expr (tpl-pmtr (scope 'Expr 'field_type)))
                                                                                                                  'StandardType))
                                                                                                 (tpl-pmtr (scope 'Expr 'field_type)))
                                                                                        (tpl-pmtr (scope (scope 'List (tpl-fcn-use 'Convert (tpl-pmtr (scope 'Expr 'field_type))))
                                                                                                         'Converted))
                                                                                        (tpl-pmtr (scope 'Expr 'field_type)))
                                                                               s))
                                                      (list (typedef (tpl-pmtr (scope 'Expr 'field_type))
                                                                     FT-chunk)
                                                            (typedef (tpl-use 'Standardize 'Expr FT-chunk)
                                                                     'Standardize)
                                                            (typedef (tpl-pmtr (scope 'Standardize 'StandardType))
                                                                     'StandardType)
                                                            (typedef (tpl-use Clause-chunk 'Initial 'BoolExpr 'StandardType FT-chunk)
                                                                     'Clause)
                                                            (typedef (tpl-pmtr (scope (scope 'List (tpl-fcn-use 'Convert (tpl-pmtr (scope 'Expr 'field_type))))
                                                                                      'Converted))
                                                                     'Previous)
                                                            (typedef (tpl-use Cond-chunk 'Initial 'Clause 'Previous FT-chunk)
                                                                     'Cond)
                                                            (typedef (tpl-use 'CondBuilder 'Cond)
                                                                     'ReturnType))
                                                      (fc 'ReturnType
                                                          (fc 'Cond
                                                              (fc 'Clause
                                                                  (mfc 'nb 'expr)
                                                                  (fc (scope 'Standardize 'standardType)
                                                                      'e))
                                                              (mfc 'list_ (tpl-fcn-use 'convert FT-chunk)))))))
                                        ; Nil
              (tpl-srt-def 'CondBuilder
                           null
                           Nil-chunk
                           (sec-def 'public
                                    (constructor-chunk 'CondBuilder null null)))
              (end-val 'cond
                       'double
                       null
                       'd)
              (end-expr 'cond
                        (tpl-pmtr (scope (tpl-use 'Standardize 'Expr (tpl-pmtr (scope 'Expr 'field_type)))
                                         'StandardTerm))
                        (list (typedef (tpl-pmtr (scope 'Expr 'field_type))
                                       FT-chunk)
                              (typedef (tpl-use 'Standardize 'Expr FT-chunk)
                                       'Standardize))
                        (fc (scope 'Standardize 'standardTerm)
                            'e))
              (cond-bool-val 'cond
                             (tpl-use 'CondBuilder (c (tpl-use SCond-chunk Nil-chunk) s))
                             (list (typedef (tpl-use SCond-chunk Nil-chunk)
                                            'Cond)
                                   (typedef (tpl-use 'CondBuilder 'Cond)
                                            'ReturnType))
                             (fc 'ReturnType
                                 (fc 'Cond
                                     (fc SClause-chunk 'b 'd)
                                     (fc Nil-chunk))))
              (cond-bool-expr 'cond
                              (tpl-use 'CondBuilder (c (tpl-use Cond-chunk
                                                                'Initial
                                                                (tpl-use Clause-chunk
                                                                         'Initial
                                                                         (tpl-use NB-chunk 'Initial (tpl-pmtr (scope 'Expr 'field_type)))
                                                                         (tpl-pmtr (scope (tpl-use 'Standardize 'Expr (tpl-pmtr (scope 'Expr 'field_type)))
                                                                                          'StandardType))
                                                                         (tpl-pmtr (scope 'Expr 'field_type)))
                                                                Nil-chunk
                                                                (tpl-pmtr (scope 'Expr 'field_type)))
                                                       s))
                              (list (typedef (tpl-pmtr (scope 'Expr 'field_type))
                                             FT-chunk)
                                    (typedef (tpl-use NB-chunk 'Initial FT-chunk)
                                             'Boolean)
                                    (typedef (tpl-use 'Standardize 'Expr FT-chunk)
                                             'Standardize)
                                    (typedef (tpl-pmtr (scope 'Standardize 'StandardType))
                                             'StandardType)
                                    (typedef (tpl-use Clause-chunk 'Initial 'Boolean 'StandardType FT-chunk)
                                             'Clause)
                                    (typedef (tpl-use Cond-chunk 'Initial 'Clause Nil-chunk FT-chunk)
                                             'Cond)
                                    (typedef (tpl-use 'CondBuilder 'Cond)
                                             'ReturnType))
                              (fc 'ReturnType
                                  (fc 'Cond
                                      (fc 'Clause
                                          (fc 'Boolean 'b)
                                          (fc (scope 'Standardize 'standardType)
                                              'e))
                                      (fc Nil-chunk))))
              (cond-NBE-val 'cond
                            #false
                            (tpl-use 'CondBuilder (c (tpl-use Cond-chunk
                                                              'Initial
                                                              (tpl-use Clause-chunk
                                                                       'Initial
                                                                       'BoolExpr
                                                                       (tpl-use NS-chunk 'Initial FT-chunk)
                                                                       FT-chunk)
                                                              Nil-chunk
                                                              FT-chunk) s))
                            (list (typedef (tpl-use NS-chunk 'Initial FT-chunk)
                                           'Scalar)
                                  (typedef (tpl-use Clause-chunk 'Initial 'BoolExpr 'Scalar FT-chunk)
                                           'Clause)
                                  (typedef (tpl-use Cond-chunk 'Initial 'Clause Nil-chunk FT-chunk)
                                           'Cond)
                                  (typedef (tpl-use 'CondBuilder 'Cond)
                                           'ReturnType))
                            (fc 'ReturnType
                                (fc 'Cond
                                    (fc 'Clause
                                        (mfc 'nb 'expr)
                                        (fc 'Scalar 'd))
                                    (fc Nil-chunk))))
              (cond-NBE-expr 'cond
                             (tpl-use 'CondBuilder (c (tpl-use Cond-chunk
                                                               'Initial
                                                               (tpl-use Clause-chunk
                                                                        'Initial
                                                                        'BoolExpr
                                                                        (tpl-pmtr (scope (tpl-use 'Standardize 'Expr (tpl-pmtr (scope 'Expr 'field_type)))
                                                                                         'StandardType))
                                                                        (tpl-pmtr (scope 'Expr 'field_type)))
                                                               Nil-chunk
                                                               (tpl-pmtr (scope 'Expr 'field_type)))
                                                      s))
                             (list (typedef (tpl-pmtr (scope 'Expr 'field_type))
                                            FT-chunk)
                                   (typedef (tpl-use 'Standardize 'Expr FT-chunk)
                                            'Standardize)
                                   (typedef (tpl-pmtr (scope 'Standardize 'StandardType))
                                            'StandardType)
                                   (typedef (tpl-use Clause-chunk 'Initial 'BoolExpr 'StandardType FT-chunk)
                                            'Clause)
                                   (typedef (tpl-use Cond-chunk 'Initial 'Clause Nil-chunk FT-chunk)
                                            'Cond)
                                   (typedef (tpl-use 'CondBuilder 'Cond)
                                            'ReturnType))
                             (fc 'ReturnType
                                 (fc 'Cond
                                     (fc 'Clause
                                         (mfc 'nb 'expr)
                                         (fc (scope 'Standardize 'standardType)
                                             'e))
                                     (fc Nil-chunk))))))
      (m 'nebo_cond null (c 'cond "//"))
      (tpl-srt-def Pair-chunk
                   (list (tpl-pmtr 'First)
                         (tpl-pmtr 'Second))
                   null
                   (typedef 'First 'FirstType)
                   (typedef 'Second 'SecondType))
      (tpl-srt-def Quad-chunk
                   (list (tpl-pmtr 'First)
                         (tpl-pmtr 'Second)
                         (tpl-pmtr 'Third)
                         (tpl-pmtr 'Fourth))
                   null
                   (typedef 'First 'FirstType)
                   (typedef 'Second 'SecondType)
                   (typedef 'Third 'ThirdType)
                   (typedef 'Fourth 'FourthType))
      (let ([NS1D 'Nebo1DStencil]
            [NS2D 'Nebo2DStencil])
        (list (build-struct NS1D
                            #true
                            (list (tpl-pmtr 'StencilType)
                                  (tpl-pmtr 'Operand))
                            (list 'StencilType 'Operand)
                            (bs-Initial (list 'StencilType
                                              (tpl-use Pair-chunk
                                                       (tpl-pmtr (scope (scope 'Operand (tpl-fcn-use 'Iterator VG-chunk (tpl-pmtr (scope (scope 'structured (tpl-use 'Add SH-chunk 'SP1))
                                                                                                                                         'result))))
                                                                        'ResizePrepType))
                                                       (tpl-pmtr (scope (scope 'Operand (tpl-fcn-use 'Iterator VG-chunk (tpl-pmtr (scope (scope 'structured (tpl-use 'Add SH-chunk 'SP2))
                                                                                                                                         'result))))
                                                                        'ResizePrepType))))
                                        (list 'StencilType
                                              (tpl-use Pair-chunk
                                                       (tpl-pmtr (scope (scope 'Operand (tpl-fcn-use 'Iterator VG-chunk (tpl-pmtr (scope (scope 'structured (tpl-use 'Add SH-chunk 'SP1))
                                                                                                                                         'result))))
                                                                        'SeqWalkType))
                                                       (tpl-pmtr (scope (scope 'Operand (tpl-fcn-use 'Iterator VG-chunk (tpl-pmtr (scope (scope 'structured (tpl-use 'Add SH-chunk 'SP2))
                                                                                                                                         'result))))
                                                                        'SeqWalkType))))
                                        (list (typedef (tpl-pmtr (scope 'StencilType 'SrcFieldType))
                                                       'SFT)
                                              (typedef (tpl-pmtr (scope 'StencilType 'DestFieldType))
                                                       'DFT)
                                              (typedef (tpl-pmtr (scope (scope 'SFT 'Location)
                                                                        'Offset))
                                                       'SFTO)
                                              (typedef (tpl-pmtr (scope (scope 'DFT 'Location)
                                                                        'Offset))
                                                       'DFTO)
                                              (typedef (tpl-pmtr (scope (scope (scope 'structured
                                                                                      (tpl-use 'GreaterThan 'SFTO 'DFTO))
                                                                               'result)
                                                                        'Negate))
                                                       'SP1)
                                              (typedef (tpl-pmtr (scope (scope 'structured
                                                                               (tpl-use 'LessThan 'SFTO 'DFTO))
                                                                        'result))
                                                       'SP2))
                                        (tpl-pmtr (scope (scope 'structured (tpl-use 'Invalidate
                                                                                     (tpl-pmtr (scope (scope 'structured (tpl-use 'Invalidate
                                                                                                                                  (tpl-pmtr (scope 'Operand report-VG-chunk))
                                                                                                                                  'SP1))
                                                                                                      'result))
                                                                                     'SP2))
                                                         'result))
                                        (bm-constructor (list (b s 'Operand const-chunk "&" 'op)
                                                              (b s 'double const-chunk 'lo)
                                                              (b s 'double const-chunk 'hi))
                                                        (list (cons-asgn 'operand_ 'op)
                                                              (cons-asgn 'lo_ 'lo)
                                                              (cons-asgn 'hi_ 'hi))
                                                        null)
                                        (list (mfc (fc 'operand)
                                                   (tpl-fcn-use 'init VG-chunk (tpl-pmtr (scope (scope 'structured (tpl-use 'Add SH-chunk 'SP1))
                                                                                                'result))))
                                              (mfc (fc 'operand)
                                                   (tpl-fcn-use 'init VG-chunk (tpl-pmtr (scope (scope 'structured (tpl-use 'Add SH-chunk 'SP2))
                                                                                                'result))))
                                              (fc 'lo)
                                              (fc 'hi))
                                        (list (mfc (fc 'operand)
                                                   (tpl-fcn-use 'resize_prep VG-chunk (tpl-pmtr (scope (scope 'structured (tpl-use 'Add SH-chunk 'SP1))
                                                                                                       'result))))
                                              (mfc (fc 'operand)
                                                   (tpl-fcn-use 'resize_prep VG-chunk (tpl-pmtr (scope (scope 'structured (tpl-use 'Add SH-chunk 'SP2))
                                                                                                       'result))))
                                              (fc 'lo)
                                              (fc 'hi))
                                        (list (r-fcn-def (constize (fcn-dcl 'operand
                                                                            (b s 'Operand const-chunk "&")))
                                                         null
                                                         'operand_)
                                              (r-fcn-def (constize (fcn-dcl 'lo
                                                                            'double))
                                                         null
                                                         'lo_)
                                              (r-fcn-def (constize (fcn-dcl 'hi
                                                                            'double))
                                                         null
                                                         'hi_))
                                        (list (b s const-chunk 'Operand 'operand_)
                                              (b s const-chunk 'double 'lo_)
                                              (b s const-chunk 'double 'hi_)))
                            (bs-ResizePrep (list 'StencilType
                                                 (tpl-use Pair-chunk
                                                          (tpl-pmtr (scope (scope 'Operand 'FirstType)
                                                                           'ResizeType))
                                                          (tpl-pmtr (scope (scope 'Operand 'SecondType)
                                                                           'ResizeType))))
                                           (list (typedef (tpl-pmtr (scope 'Operand 'FirstType))
                                                          'Operand1)
                                                 (typedef (tpl-pmtr (scope 'Operand 'SecondType))
                                                          'Operand2))
                                           (bm-constructor (list (b s 'Operand1 const-chunk "&" 'op1)
                                                                 (b s 'Operand2 const-chunk "&" 'op2)
                                                                 (b s 'double const-chunk 'lo)
                                                                 (b s 'double const-chunk 'hi))
                                                           (list (cons-asgn 'operand1_ 'op1)
                                                                 (cons-asgn 'operand2_ 'op2)
                                                                 (cons-asgn 'lo_ 'lo)
                                                                 (cons-asgn 'hi_ 'hi))
                                                           null)
                                           (list (mfc (fc 'operand1)
                                                      'resize
                                                      'size
                                                      'split
                                                      'location)
                                                 (mfc (fc 'operand2)
                                                      'resize
                                                      'size
                                                      'split
                                                      'location)
                                                 (fc 'lo)
                                                 (fc 'hi))
                                           (list (r-fcn-def (constize (fcn-dcl 'operand1
                                                                               (b s 'Operand1 const-chunk "&")))
                                                            null
                                                            'operand1_)
                                                 (r-fcn-def (constize (fcn-dcl 'operand2
                                                                               (b s 'Operand2 const-chunk "&")))
                                                            null
                                                            'operand2_)
                                                 (r-fcn-def (constize (fcn-dcl 'lo
                                                                               'double))
                                                            null
                                                            'lo_)
                                                 (r-fcn-def (constize (fcn-dcl 'hi
                                                                               'double))
                                                            null
                                                            'hi_))
                                           (list (b s const-chunk 'Operand1 'operand1_)
                                                 (b s const-chunk 'Operand2 'operand2_)
                                                 (b s const-chunk 'double 'lo_)
                                                 (b s const-chunk 'double 'hi_)))
                            (bs-Resize (list 'StencilType
                                             (tpl-use Pair-chunk
                                                      (tpl-pmtr (scope (scope 'Operand 'FirstType)
                                                                       'SeqWalkType))
                                                      (tpl-pmtr (scope (scope 'Operand 'SecondType)
                                                                       'SeqWalkType))))
                                       (list (typedef (tpl-pmtr (scope 'Operand 'FirstType))
                                                      'Operand1)
                                             (typedef (tpl-pmtr (scope 'Operand 'SecondType))
                                                      'Operand2))
                                       (bm-constructor (list (b s 'Operand1 const-chunk "&" 'op1)
                                                             (b s 'Operand2 const-chunk "&" 'op2)
                                                             (b s 'double const-chunk 'lo)
                                                             (b s 'double const-chunk 'hi))
                                                       (list (cons-asgn 'operand1_ 'op1)
                                                             (cons-asgn 'operand2_ 'op2)
                                                             (cons-asgn 'lo_ 'lo)
                                                             (cons-asgn 'hi_ 'hi))
                                                       null)
                                       (list (mfc (fc 'operand1)
                                                  'init)
                                             (mfc (fc 'operand2)
                                                  'init)
                                             (fc 'lo)
                                             (fc 'hi))
                                       (list (r-fcn-def (constize (fcn-dcl 'operand1
                                                                           (b s 'Operand1 const-chunk "&")))
                                                        null
                                                        'operand1_)
                                             (r-fcn-def (constize (fcn-dcl 'operand2
                                                                           (b s 'Operand2 const-chunk "&")))
                                                        null
                                                        'operand2_)
                                             (r-fcn-def (constize (fcn-dcl 'lo
                                                                           'double))
                                                        null
                                                        'lo_)
                                             (r-fcn-def (constize (fcn-dcl 'hi
                                                                           'double))
                                                        null
                                                        'hi_))
                                       (list (b s const-chunk 'Operand1 'operand1_)
                                             (b s const-chunk 'Operand2 'operand2_)
                                             (b s const-chunk 'double 'lo_)
                                             (b s const-chunk 'double 'hi_)))
                            (bs-SeqWalk (list (typedef (tpl-pmtr (scope 'Operand 'FirstType))
                                                       'Operand1)
                                              (typedef (tpl-pmtr (scope 'Operand 'SecondType))
                                                       'Operand2))
                                        (bm-constructor (list (b s 'Operand1 const-chunk "&" 'op1)
                                                              (b s 'Operand2 const-chunk "&" 'op2)
                                                              (b s 'double const-chunk 'lo)
                                                              (b s 'double const-chunk 'hi))
                                                        (list (cons-asgn 'operand1_ 'op1)
                                                              (cons-asgn 'operand2_ 'op2)
                                                              (cons-asgn 'lo_ 'lo)
                                                              (cons-asgn 'hi_ 'hi))
                                                        null)
                                        (list (mfc 'operand1_ 'next)
                                              (mfc 'operand2_ 'next))
                                        (b s
                                           (mfc 'operand1_ 'at_end)
                                           "||"
                                           (mfc 'operand2_ 'at_end))
                                        (b s
                                           (mfc 'operand1_ 'has_length)
                                           "||"
                                           (mfc 'operand2_ 'has_length))
                                        (r-fcn-def (constize (fcn-dcl 'eval
                                                                      (tpl-pmtr (scope FT-chunk 'value_type))))
                                                   null
                                                   (b s
                                                      (mfc 'operand1_ 'eval)
                                                      "*"
                                                      'lo_
                                                      "+"
                                                      (mfc 'operand2_ 'eval)
                                                      "*"
                                                      'hi_))
                                        (list (b s 'Operand1 'operand1_)
                                              (b s 'Operand2 'operand2_)
                                              (b s const-chunk 'double 'lo_)
                                              (b s const-chunk 'double 'hi_))))
              (let ([pt-desc
                     (lambda (pt
                              type)
                       (tpl-pmtr (scope (scope 'Operand (tpl-fcn-use 'Iterator VG-chunk (tpl-pmtr (scope (scope 'structured (tpl-use 'Add SH-chunk pt))
                                                                                                         'result))))
                                        type)))]
                    [invalidate
                     (lambda (given-valid point)
                       (tpl-pmtr (scope (scope 'structured (tpl-use 'Invalidate given-valid point))
                                        'result)))]
                    [minimum
                     (lambda (first second)
                       (tpl-pmtr (scope (scope 'structured (tpl-use 'Minimum first second))
                                        'result)))]
                    [set-up-point
                     (lambda (call point)
                       (mfc (fc 'operand)
                            (tpl-fcn-use call VG-chunk (tpl-pmtr (scope (scope 'structured (tpl-use 'Add SH-chunk point))
                                                                        'result)))))]
                    [coef-accessor
                     (lambda (num)
                       (r-fcn-def (constize (fcn-dcl (c 'coef num)
                                                     'double))
                                  null
                                  (c 'coef num "_")))]
                    [operand-call
                     (lambda (num)
                       (mfc (fc (c 'operand num))
                            'resize
                            'size
                            'split
                            'location))]
                    [operand-accessor
                     (lambda (num)
                       (r-fcn-def (constize (fcn-dcl (c 'operand num)
                                                     (b s (c 'Operand num) const-chunk "&")))
                                  null
                                  (c 'operand num "_")))]
                    [eval-mult
                     (lambda (num)
                       (b s
                          (mfc (c 'operand num "_")
                               'eval)
                          "*"
                          (c 'coef num "_")))]
                    [int-cast
                     (lambda (chunk)
                       (c (p 'int) (p (c chunk))))])
                (build-struct NS2D
                              #true
                              (list (tpl-pmtr 'StencilType)
                                    (tpl-pmtr 'Operand))
                              (list 'StencilType 'Operand)
                              (bs-Initial (list 'StencilType
                                                (tpl-use Quad-chunk
                                                         (pt-desc 'SP1 'ResizePrepType)
                                                         (pt-desc 'SP2 'ResizePrepType)
                                                         (pt-desc 'SP3 'ResizePrepType)
                                                         (pt-desc 'SP4 'ResizePrepType)))
                                          (list 'StencilType
                                                (tpl-use Quad-chunk
                                                         (pt-desc 'SP1 'SeqWalkType)
                                                         (pt-desc 'SP2 'SeqWalkType)
                                                         (pt-desc 'SP3 'SeqWalkType)
                                                         (pt-desc 'SP4 'SeqWalkType)))
                                          (list (typedef (tpl-pmtr (scope 'StencilType 'SrcFieldType))
                                                         'SFT)
                                                (typedef (tpl-pmtr (scope 'StencilType 'DestFieldType))
                                                         'DFT)
                                                (typedef (tpl-pmtr (scope (scope 'SFT 'Location)
                                                                          'Offset))
                                                         'SFTO)
                                                (typedef (tpl-pmtr (scope (scope 'DFT 'Location)
                                                                          'Offset))
                                                         'DFTO)
                                                (typedef (tpl-use (scope 'structured 'IndexTriplet) "1" "0" "0")
                                                         'XUnit)
                                                (typedef (tpl-use (scope 'structured 'IndexTriplet) "0" "1" "0")
                                                         'YUnit)
                                                (typedef (tpl-use (scope 'structured 'IndexTriplet) "0" "0" "1")
                                                         'ZUnit)
                                                (typedef (tpl-pmtr (scope (tpl-use 'TemplateIf
                                                                                   (p (b s (int-cast (scope 'SFTO 'X)) "!=" (int-cast (scope 'DFTO 'X))))
                                                                                   'XUnit
                                                                                   'YUnit)
                                                                          'result))
                                                         'D1)
                                                (typedef (tpl-pmtr (scope (tpl-use 'TemplateIf
                                                                                   (p (b s (int-cast (scope 'SFTO 'Z)) "!=" (int-cast (scope 'DFTO 'Z))))
                                                                                   'ZUnit
                                                                                   'YUnit)
                                                                          'result))
                                                         'D2)
                                                (typedef (tpl-pmtr (scope (tpl-use (scope 'structured 'Multiply) 'SFTO 'D1)
                                                                          'result))
                                                         'SFTD1)
                                                (typedef (tpl-pmtr (scope (tpl-use (scope 'structured 'Multiply) 'SFTO 'D2)
                                                                          'result))
                                                         'SFTD2)
                                                (typedef (tpl-pmtr (scope (tpl-use (scope 'structured 'Multiply) 'DFTO 'D1)
                                                                          'result))
                                                         'DFTD1)
                                                (typedef (tpl-pmtr (scope (tpl-use (scope 'structured 'Multiply) 'DFTO 'D2)
                                                                          'result))
                                                         'DFTD2)
                                                (typedef (tpl-pmtr (scope (scope (scope 'structured
                                                                                        (tpl-use 'GreaterThan 'SFTD1 'DFTD1))
                                                                                 'result)
                                                                          'Negate))
                                                         'LoD1)
                                                (typedef (tpl-pmtr (scope (scope 'structured
                                                                                 (tpl-use 'LessThan 'SFTD1 'DFTD1))
                                                                          'result))
                                                         'HiD1)
                                                (typedef (tpl-pmtr (scope (scope (scope 'structured
                                                                                        (tpl-use 'GreaterThan 'SFTD2 'DFTD2))
                                                                                 'result)
                                                                          'Negate))
                                                         'LoD2)
                                                (typedef (tpl-pmtr (scope (scope 'structured
                                                                                 (tpl-use 'LessThan 'SFTD2 'DFTD2))
                                                                          'result))
                                                         'HiD2)
                                                (typedef (tpl-pmtr (scope (scope 'structured
                                                                           (tpl-use 'Add 'LoD1 'LoD2))
                                                                          'result))
                                                         'SP1)
                                                (typedef (tpl-pmtr (scope (scope 'structured
                                                                                 (tpl-use 'Add 'HiD1 'LoD2))
                                                                          'result))
                                                         'SP2)
                                                (typedef (tpl-pmtr (scope (scope 'structured
                                                                                 (tpl-use 'Add 'LoD1 'HiD2))
                                                                          'result))
                                                         'SP3)
                                                (typedef (tpl-pmtr (scope (scope 'structured
                                                                                 (tpl-use 'Add 'HiD1 'HiD2))
                                                                          'result))
                                                         'SP4)
                                                (typedef (tpl-pmtr (scope 'Operand report-VG-chunk))
                                                         'OperandPVG)
                                                (typedef (invalidate 'OperandPVG 'SP1)
                                                         'SP1PVG)
                                                (typedef (invalidate 'OperandPVG 'SP2)
                                                         'SP2PVG)
                                                (typedef (invalidate 'OperandPVG 'SP3)
                                                         'SP3PVG)
                                                (typedef (invalidate 'OperandPVG 'SP4)
                                                         'SP4PVG)
                                                (typedef (minimum 'SP1PVG 'SP2PVG)
                                                         'PVG12)
                                                (typedef (minimum 'PVG12 'SP3PVG)
                                                         'PVG123)
                                                (typedef (minimum 'PVG123 'SP4PVG)
                                                         'PVG1234))
                                          'PVG1234
                                          (bm-constructor (list (b s 'Operand const-chunk "&" 'op)
                                                                (b s 'double const-chunk 'coef1)
                                                                (b s 'double const-chunk 'coef2)
                                                                (b s 'double const-chunk 'coef3)
                                                                (b s 'double const-chunk 'coef4))
                                                          (list (cons-asgn 'operand_ 'op)
                                                                (cons-asgn 'coef1_ 'coef1)
                                                                (cons-asgn 'coef2_ 'coef2)
                                                                (cons-asgn 'coef3_ 'coef3)
                                                                (cons-asgn 'coef4_ 'coef4))
                                                          null)
                                          (list (set-up-point 'init 'SP1)
                                                (set-up-point 'init 'SP2)
                                                (set-up-point 'init 'SP3)
                                                (set-up-point 'init 'SP4)
                                                (fc 'coef1)
                                                (fc 'coef2)
                                                (fc 'coef3)
                                                (fc 'coef4))
                                          (list (set-up-point 'resize_prep 'SP1)
                                                (set-up-point 'resize_prep 'SP2)
                                                (set-up-point 'resize_prep 'SP3)
                                                (set-up-point 'resize_prep 'SP4)
                                                (fc 'coef1)
                                                (fc 'coef2)
                                                (fc 'coef3)
                                                (fc 'coef4))
                                          (list (r-fcn-def (constize (fcn-dcl 'operand
                                                                              (b s 'Operand const-chunk "&")))
                                                           null
                                                           'operand_)
                                                (coef-accessor "1")
                                                (coef-accessor "2")
                                                (coef-accessor "3")
                                                (coef-accessor "4"))
                                          (list (b s const-chunk 'Operand 'operand_)
                                                (b s const-chunk 'double 'coef1_)
                                                (b s const-chunk 'double 'coef2_)
                                                (b s const-chunk 'double 'coef3_)
                                                (b s const-chunk 'double 'coef4_)))
                              (bs-ResizePrep (list 'StencilType
                                                   (tpl-use Quad-chunk
                                                            (tpl-pmtr (scope (scope 'Operand 'FirstType)
                                                                             'ResizeType))
                                                            (tpl-pmtr (scope (scope 'Operand 'SecondType)
                                                                             'ResizeType))
                                                            (tpl-pmtr (scope (scope 'Operand 'ThirdType)
                                                                             'ResizeType))
                                                            (tpl-pmtr (scope (scope 'Operand 'FourthType)
                                                                             'ResizeType))))
                                             (list (typedef (tpl-pmtr (scope 'Operand 'FirstType))
                                                            'Operand1)
                                                   (typedef (tpl-pmtr (scope 'Operand 'SecondType))
                                                            'Operand2)
                                                   (typedef (tpl-pmtr (scope 'Operand 'ThirdType))
                                                            'Operand3)
                                                   (typedef (tpl-pmtr (scope 'Operand 'FourthType))
                                                            'Operand4))
                                             (bm-constructor (list (b s 'Operand1 const-chunk "&" 'op1)
                                                                   (b s 'Operand2 const-chunk "&" 'op2)
                                                                   (b s 'Operand3 const-chunk "&" 'op3)
                                                                   (b s 'Operand4 const-chunk "&" 'op4)
                                                                   (b s 'double const-chunk 'coef1)
                                                                   (b s 'double const-chunk 'coef2)
                                                                   (b s 'double const-chunk 'coef3)
                                                                   (b s 'double const-chunk 'coef4))
                                                             (list (cons-asgn 'operand1_ 'op1)
                                                                   (cons-asgn 'operand2_ 'op2)
                                                                   (cons-asgn 'operand3_ 'op3)
                                                                   (cons-asgn 'operand4_ 'op4)
                                                                   (cons-asgn 'coef1_ 'coef1)
                                                                   (cons-asgn 'coef2_ 'coef2)
                                                                   (cons-asgn 'coef3_ 'coef3)
                                                                   (cons-asgn 'coef4_ 'coef4))
                                                             null)
                                             (list (operand-call "1")
                                                   (operand-call "2")
                                                   (operand-call "3")
                                                   (operand-call "4")
                                                   (fc 'coef1)
                                                   (fc 'coef2)
                                                   (fc 'coef3)
                                                   (fc 'coef4))
                                             (list (operand-accessor "1")
                                                   (operand-accessor "2")
                                                   (operand-accessor "3")
                                                   (operand-accessor "4")
                                                   (coef-accessor "1")
                                                   (coef-accessor "2")
                                                   (coef-accessor "3")
                                                   (coef-accessor "4"))
                                             (list (b s const-chunk 'Operand1 'operand1_)
                                                   (b s const-chunk 'Operand2 'operand2_)
                                                   (b s const-chunk 'Operand3 'operand3_)
                                                   (b s const-chunk 'Operand4 'operand4_)
                                                   (b s const-chunk 'double 'coef1_)
                                                   (b s const-chunk 'double 'coef2_)
                                                   (b s const-chunk 'double 'coef3_)
                                                   (b s const-chunk 'double 'coef4_)))
                              (bs-Resize (list 'StencilType
                                               (tpl-use Quad-chunk
                                                        (tpl-pmtr (scope (scope 'Operand 'FirstType)
                                                                         'SeqWalkType))
                                                        (tpl-pmtr (scope (scope 'Operand 'SecondType)
                                                                         'SeqWalkType))
                                                        (tpl-pmtr (scope (scope 'Operand 'ThirdType)
                                                                         'SeqWalkType))
                                                        (tpl-pmtr (scope (scope 'Operand 'FourthType)
                                                                         'SeqWalkType))))
                                         (list (typedef (tpl-pmtr (scope 'Operand 'FirstType))
                                                        'Operand1)
                                               (typedef (tpl-pmtr (scope 'Operand 'SecondType))
                                                        'Operand2)
                                               (typedef (tpl-pmtr (scope 'Operand 'ThirdType))
                                                        'Operand3)
                                               (typedef (tpl-pmtr (scope 'Operand 'FourthType))
                                                        'Operand4))
                                         (bm-constructor (list (b s 'Operand1 const-chunk "&" 'op1)
                                                               (b s 'Operand2 const-chunk "&" 'op2)
                                                               (b s 'Operand3 const-chunk "&" 'op3)
                                                               (b s 'Operand4 const-chunk "&" 'op4)
                                                               (b s 'double const-chunk 'coef1)
                                                               (b s 'double const-chunk 'coef2)
                                                               (b s 'double const-chunk 'coef3)
                                                               (b s 'double const-chunk 'coef4))
                                                         (list (cons-asgn 'operand1_ 'op1)
                                                               (cons-asgn 'operand2_ 'op2)
                                                               (cons-asgn 'operand3_ 'op3)
                                                               (cons-asgn 'operand4_ 'op4)
                                                               (cons-asgn 'coef1_ 'coef1)
                                                               (cons-asgn 'coef2_ 'coef2)
                                                               (cons-asgn 'coef3_ 'coef3)
                                                               (cons-asgn 'coef4_ 'coef4))
                                                         null)
                                         (list (mfc (fc 'operand1)
                                                    'init)
                                               (mfc (fc 'operand2)
                                                    'init)
                                               (mfc (fc 'operand3)
                                                    'init)
                                               (mfc (fc 'operand4)
                                                    'init)
                                               (fc 'coef1)
                                               (fc 'coef2)
                                               (fc 'coef3)
                                               (fc 'coef4))
                                         (list (operand-accessor "1")
                                               (operand-accessor "2")
                                               (operand-accessor "3")
                                               (operand-accessor "4")
                                               (coef-accessor "1")
                                               (coef-accessor "2")
                                               (coef-accessor "3")
                                               (coef-accessor "4"))
                                         (list (b s const-chunk 'Operand1 'operand1_)
                                               (b s const-chunk 'Operand2 'operand2_)
                                               (b s const-chunk 'Operand3 'operand3_)
                                               (b s const-chunk 'Operand4 'operand4_)
                                               (b s const-chunk 'double 'coef1_)
                                               (b s const-chunk 'double 'coef2_)
                                               (b s const-chunk 'double 'coef3_)
                                               (b s const-chunk 'double 'coef4_)))
                              (bs-SeqWalk (list (typedef (tpl-pmtr (scope 'Operand 'FirstType))
                                                         'Operand1)
                                                (typedef (tpl-pmtr (scope 'Operand 'SecondType))
                                                         'Operand2)
                                                (typedef (tpl-pmtr (scope 'Operand 'ThirdType))
                                                         'Operand3)
                                                (typedef (tpl-pmtr (scope 'Operand 'FourthType))
                                                         'Operand4))
                                          (bm-constructor (list (b s 'Operand1 const-chunk "&" 'op1)
                                                                (b s 'Operand2 const-chunk "&" 'op2)
                                                                (b s 'Operand3 const-chunk "&" 'op3)
                                                                (b s 'Operand4 const-chunk "&" 'op4)
                                                                (b s 'double const-chunk 'coef1)
                                                                (b s 'double const-chunk 'coef2)
                                                                (b s 'double const-chunk 'coef3)
                                                                (b s 'double const-chunk 'coef4))
                                                          (list (cons-asgn 'operand1_ 'op1)
                                                                (cons-asgn 'operand2_ 'op2)
                                                                (cons-asgn 'operand3_ 'op3)
                                                                (cons-asgn 'operand4_ 'op4)
                                                                (cons-asgn 'coef1_ 'coef1)
                                                                (cons-asgn 'coef2_ 'coef2)
                                                                (cons-asgn 'coef3_ 'coef3)
                                                                (cons-asgn 'coef4_ 'coef4))
                                                          null)
                                          (list (mfc 'operand1_ 'next)
                                                (mfc 'operand2_ 'next)
                                                (mfc 'operand3_ 'next)
                                                (mfc 'operand4_ 'next))
                                          (b/a s (c "||" s)
                                               (mfc 'operand1_ 'at_end)
                                               (mfc 'operand2_ 'at_end)
                                               (mfc 'operand3_ 'at_end)
                                               (mfc 'operand4_ 'at_end))
                                          (b/a s (c "||" s)
                                               (mfc 'operand1_ 'has_length)
                                               (mfc 'operand2_ 'has_length)
                                               (mfc 'operand3_ 'has_length)
                                               (mfc 'operand4_ 'has_length))
                                          (r-fcn-def (constize (fcn-dcl 'eval
                                                                        (tpl-pmtr (scope FT-chunk 'value_type))))
                                                     null
                                                     (b/a s (c "+" new-line-chunk)
                                                          (eval-mult "1")
                                                          (eval-mult "2")
                                                          (eval-mult "3")
                                                          (eval-mult "4")))
                                          (list (b s 'Operand1 'operand1_)
                                                (b s 'Operand2 'operand2_)
                                                (b s 'Operand3 'operand3_)
                                                (b s 'Operand4 'operand4_)
                                                (b s const-chunk 'double 'coef1_)
                                                (b s const-chunk 'double 'coef2_)
                                                (b s const-chunk 'double 'coef3_)
                                                (b s const-chunk 'double 'coef4_)))))
              (tpl-srt-def 'Nebo1DStencilConstructor
                           (tpl-pmtr 'StencilType)
                           null
                           (sec-def private-chunk
                                    (b s const-chunk 'double 'lo_)
                                    (b s const-chunk 'double 'hi_))
                           (sec-def public-chunk
                                    (constructor-chunk 'Nebo1DStencilConstructor
                                                       (b s const-chunk 'StencilType "*" const-chunk 'stencil)
                                                       (list (cons-asgn 'lo_ (c 'stencil "->" (fc 'get_minus_coef)))
                                                             (cons-asgn 'hi_ (c 'stencil "->" (fc 'get_plus_coef))))
                                                       null)
                                    (typedef (tpl-pmtr (scope 'StencilType 'DestFieldType))
                                             FT-chunk)
                                    (typedef (tpl-pmtr (scope 'StencilType 'SrcFieldType))
                                             'OpFieldType)
                                    (typedef (tpl-use NCF-chunk 'Initial 'OpFieldType)
                                             'OpType)
                                    (typedef (tpl-use 'Nebo1DStencil 'Initial 'StencilType 'OpType FT-chunk)
                                             'StandardType)
                                    (typedef (tpl-use NE-chunk 'StandardType FT-chunk)
                                             'StandardTerm)
                                    (tpl-srt-def 'OperandInfo
                                                 (tpl-pmtr 'OperandType)
                                                 null
                                                 (typedef (tpl-use 'Nebo1DStencil 'Initial 'StencilType 'OperandType FT-chunk)
                                                          'StandardType)
                                                 (typedef (tpl-use NE-chunk 'StandardType FT-chunk)
                                                          'StandardTerm))
                                    (r-fcn-def (constize (fcn-dcl (c 'operator (p))
                                                                  'StandardTerm
                                                                  (b s (tpl-pmtr (scope 'StencilType 'SrcFieldType)) const-chunk "&" 'f)))
                                               null
                                               (fc 'StandardTerm
                                                   (fc 'StandardType
                                                       (fc 'OpType 'f)
                                                       'lo_
                                                       'hi_)))
                                    (tpl-def (tpl-pmtr 'Operand)
                                             (r-fcn-def (constize (fcn-dcl (c 'operator (p))
                                                                           (tpl-pmtr (scope (tpl-use 'OperandInfo 'Operand) 'StandardTerm))
                                                                           (b s
                                                                              (tpl-use NE-chunk 'Operand 'OpFieldType)
                                                                              const-chunk
                                                                              "&"
                                                                              'fexpr)))
                                                        (list (typedef (tpl-pmtr (scope (tpl-use 'OperandInfo 'Operand) 'StandardType))
                                                                       'StandardType)
                                                              (typedef (tpl-pmtr (scope (tpl-use 'OperandInfo 'Operand) 'StandardTerm))
                                                                       'StandardTerm))
                                                        (fc 'StandardTerm
                                                            (fc 'StandardType
                                                                (mfc 'fexpr 'expr)
                                                                'lo_
                                                                'hi_))))))
              (tpl-srt-def 'Nebo2DStencilConstructor
                           (tpl-pmtr 'StencilType)
                           null
                           (sec-def private-chunk
                                    (b s const-chunk 'double 'coef1_)
                                    (b s const-chunk 'double 'coef2_)
                                    (b s const-chunk 'double 'coef3_)
                                    (b s const-chunk 'double 'coef4_))
                           (sec-def public-chunk
                                    (constructor-chunk 'Nebo2DStencilConstructor
                                                       (b s const-chunk 'StencilType "*" const-chunk 'stencil)
                                                       (list (cons-asgn 'coef1_ (c 'stencil "->" (fc 'get_coef1)))
                                                             (cons-asgn 'coef2_ (c 'stencil "->" (fc 'get_coef2)))
                                                             (cons-asgn 'coef3_ (c 'stencil "->" (fc 'get_coef3)))
                                                             (cons-asgn 'coef4_ (c 'stencil "->" (fc 'get_coef4))))
                                                       null)
                                    (typedef (tpl-pmtr (scope 'StencilType 'DestFieldType))
                                             FT-chunk)
                                    (typedef (tpl-pmtr (scope 'StencilType 'SrcFieldType))
                                             'OpFieldType)
                                    (typedef (tpl-use NCF-chunk 'Initial 'OpFieldType)
                                             'OpType)
                                    (typedef (tpl-use 'Nebo2DStencil 'Initial 'StencilType 'OpType FT-chunk)
                                             'StandardType)
                                    (typedef (tpl-use NE-chunk 'StandardType FT-chunk)
                                             'StandardTerm)
                                    (tpl-srt-def 'OperandInfo
                                                 (tpl-pmtr 'OperandType)
                                                 null
                                                 (typedef (tpl-use 'Nebo2DStencil 'Initial 'StencilType 'OperandType FT-chunk)
                                                          'StandardType)
                                                 (typedef (tpl-use NE-chunk 'StandardType FT-chunk)
                                                          'StandardTerm))
                                    (r-fcn-def (constize (fcn-dcl (c 'operator (p))
                                                                  'StandardTerm
                                                                  (b s (tpl-pmtr (scope 'StencilType 'SrcFieldType)) const-chunk "&" 'f)))
                                               null
                                               (fc 'StandardTerm
                                                   (fc 'StandardType
                                                       (fc 'OpType 'f)
                                                       'coef1_
                                                       'coef2_
                                                       'coef3_
                                                       'coef4_)))
                                    (tpl-def (tpl-pmtr 'Operand)
                                             (r-fcn-def (constize (fcn-dcl (c 'operator (p))
                                                                           (tpl-pmtr (scope (tpl-use 'OperandInfo 'Operand) 'StandardTerm))
                                                                           (b s
                                                                              (tpl-use NE-chunk 'Operand 'OpFieldType)
                                                                              const-chunk
                                                                              "&"
                                                                              'fexpr)))
                                                        (list (typedef (tpl-pmtr (scope (tpl-use 'OperandInfo 'Operand) 'StandardType))
                                                                       'StandardType)
                                                              (typedef (tpl-pmtr (scope (tpl-use 'OperandInfo 'Operand) 'StandardTerm))
                                                                       'StandardTerm))
                                                        (fc 'StandardTerm
                                                            (fc 'StandardType
                                                                (mfc 'fexpr 'expr)
                                                                'coef1_
                                                                'coef2_
                                                                'coef3_
                                                                'coef4_))))))))
      (tpl-def (list (tpl-pmtr 'LhsType)
                     (tpl-pmtr 'RhsType))
               (v-fcn-def 'nebo_assignment_sequential_execute_internal
                          (list (c 'LhsType s 'lhs)
                                (c 'RhsType s 'rhs))
                          (c 'while
                             (p (c "!" (mfc 'lhs 'at_end)))
                             (body-chunk (b s
                                            (mfc 'lhs 'ref)
                                            "="
                                            (mfc 'rhs 'eval))
                                         (mfc 'lhs 'next)
                                         (mfc 'rhs 'next)))))
      (tpl-def (list (tpl-pmtr 'ValidGhost)
                     (tpl-pmtr 'InitialShift)
                     (tpl-pmtr 'ExprType)
                     (tpl-pmtr FT-chunk))
               (r-fcn-def (fcn-dcl 'nebo_assignment_sequential_execute
                                   (b s FT-chunk const-chunk "&")
                                   (list (b s FT-chunk "&" 'initial_lhs)
                                         (b s
                                            (tpl-use NE-chunk 'ExprType FT-chunk)
                                            const-chunk
                                            "&"
                                            'initial_rhs)))
                          (fc 'nebo_assignment_sequential_execute_internal
                              (mfc (fc (tpl-use NF-chunk 'Initial FT-chunk)
                                       'initial_lhs)
                                   (tpl-fcn-use 'init 'ValidGhost 'InitialShift))
                              (mfc (mfc 'initial_rhs 'expr)
                                   (tpl-fcn-use 'init 'ValidGhost 'InitialShift)))
                          'initial_lhs))
      (pp-conditional-ifdef-chunk
       'FIELD_EXPRESSION_THREADS
       (tpl-def (list (tpl-pmtr 'ResizeLhsType)
                      (tpl-pmtr 'ResizeRhsType)
                      (tpl-pmtr FT-chunk))
                (v-fcn-def 'nebo_assignment_thread_parallel_execute_internal
                           (list (b s 'ResizeLhsType "&" 'lhs)
                                 (b s 'ResizeRhsType const-chunk "&" 'rhs)
                                 (b s
                                    (tpl-pmtr (scope FT-chunk 'memory_window))
                                    const-chunk
                                    "&"
                                    'window)
                                 (b s IntVec const-chunk "&" 'split)
                                 (b s IntVec const-chunk "&" 'location)
                                 (b s
                                    (scope 'BI 'interprocess_semaphore)
                                    "*"
                                    'semaphore))
                           (list (fc 'nebo_assignment_sequential_execute_internal
                                     (mfc (mfc 'lhs 'resize 'window 'split 'location)
                                          'init)
                                     (mfc (mfc 'rhs 'resize 'window 'split 'location)
                                          'init))
                                 (fc (c 'semaphore "->" 'post))))))
      (pp-conditional-ifdef-chunk
       'FIELD_EXPRESSION_THREADS
       (tpl-def (list (tpl-pmtr 'ValidGhost)
                      (tpl-pmtr 'InitialShift)
                      (tpl-pmtr 'ExprType)
                      (tpl-pmtr FT-chunk))
                (r-fcn-def (fcn-dcl 'nebo_assignment_thread_parallel_execute
                                    (b s FT-chunk const-chunk "&")
                                    (list (b s FT-chunk "&" 'initial_lhs)
                                          (b s
                                             (tpl-use NE-chunk 'ExprType FT-chunk)
                                             const-chunk
                                             "&"
                                             'initial_rhs)
                                          (b s 'int const-chunk 'number_of_partitions)))
                           (list (typedef (tpl-pmtr (scope (scope (tpl-use NF-chunk 'Initial FT-chunk)
                                                                  (tpl-fcn-use 'Iterator 'ValidGhost 'InitialShift))
                                                           'ResizePrepType))
                                          'LhsType)
                                 (typedef (tpl-pmtr (scope (scope 'ExprType (tpl-fcn-use 'Iterator 'ValidGhost 'InitialShift))
                                                           'ResizePrepType))
                                          'RhsType)
                                 (typedef (tpl-pmtr (scope FT-chunk 'memory_window))
                                          'MemoryWindow)
                                 (b s
                                    'MemoryWindow
                                    'window
                                    "="
                                    (mfc (mfc 'initial_lhs 'window_with_ghost)
                                         (tpl-fcn-use 'resizeGhost
                                                      (tpl-pmtr (scope (scope 'structured (tpl-use 'FromGhost
                                                                                                   (tpl-pmtr (scope FT-chunk 'Ghost))
                                                                                                   (tpl-pmtr (scope (scope FT-chunk 'Location)
                                                                                                                    'BCExtra))))
                                                                      'result))
                                                      VG-chunk)))
                                 (let ([=1 (lambda (sym) (b s 'int sym "=" "1"))])
                                   (smt-list-chunk new-line-chunk
                                                   (=1 'x)
                                                   (=1 'y)
                                                   (=1 'z)))
                                 (b new-line-chunk
                                    (c 'if
                                       (p (b s 'number_of_partitions "<=" (mfc 'window 'extent "2")))
                                       (body-chunk (b s 'z "=" 'number_of_partitions)))
                                    (c (b s 'else 'if)
                                       (p (b s 'number_of_partitions "<=" (mfc 'window 'extent "1")))
                                       (body-chunk (b s 'y "="'number_of_partitions)))
                                    (c (b s 'else 'if)
                                       (p (b s 'number_of_partitions "<=" (mfc 'window 'extent "0")))
                                       (body-chunk (b s 'x "=" 'number_of_partitions))))
                                 (b s IntVec 'split "=" (fc IntVec 'x 'y 'z))
                                 (b s
                                    (scope 'std (tpl-use 'vector (tpl-pmtr (scope FT-chunk 'memory_window))))
                                    'vec_window
                                    "="
                                    (mfc 'window 'split 'split))
                                 (b s
                                    (scope 'BI 'interprocess_semaphore)
                                    (fc 'semaphore "0"))
                                 (b s
                                    (tpl-pmtr (scope (scope 'std (tpl-use 'vector (tpl-pmtr (scope FT-chunk 'memory_window))))
                                                     'const_iterator))
                                    'window_iterator
                                    "="
                                    (mfc 'vec_window 'begin))
                                 (b s
                                    (tpl-pmtr (scope (scope 'std (tpl-use 'vector (tpl-pmtr (scope FT-chunk 'memory_window))))
                                                     'const_iterator))
                                    'window_end
                                    "="
                                    (mfc 'vec_window 'end))
                                 (b s 'int 'count "=" "0")
                                 (c 'for
                                    (p (b (c semi-colon-chunk s)
                                          empty-chunk
                                          (b s 'window_iterator "!=" 'window_end)
                                          (c "++" 'window_iterator comma-chunk
                                             "++" 'count)))
                                    (body-chunk (let ([option (lambda (arg) (p (b s (p (b s arg "==" "1"))
                                                                                  "?"
                                                                                  "0"
                                                                                  colon-chunk
                                                                                  'count)))])
                                                  (b s IntVec 'location "=" (fc IntVec
                                                                                (option 'x)
                                                                                (option 'y)
                                                                                (option 'z))))
                                                (mfc (fc (scope 'ThreadPoolFIFO 'self))
                                                     'schedule
                                                     (fc (scope 'boost 'bind)
                                                         (c "&" (tpl-use 'nebo_assignment_thread_parallel_execute_internal 'LhsType 'RhsType FT-chunk))
                                                         (mfc (fc (tpl-use NF-chunk 'Initial FT-chunk)
                                                                  'initial_lhs)
                                                              (tpl-fcn-use 'resize_prep 'ValidGhost 'InitialShift))
                                                         (mfc (mfc 'initial_rhs 'expr)
                                                              (tpl-fcn-use 'resize_prep 'ValidGhost 'InitialShift))
                                                         (c  "*" 'window_iterator)
                                                         'split
                                                         'location
                                                         (c "&" 'semaphore)))))
                                 (b s 'int 'ee "=" (mfc 'vec_window 'size))
                                 (c 'for
                                    (p (b (c s semi-colon-chunk)
                                          (b s 'int 'ii "=" "0")
                                          (b s 'ii "<" 'ee)
                                          (c 'ii "++")))
                                    (body-chunk (mfc 'semaphore 'wait))))
                           'initial_lhs)))
      (tpl-def (list (tpl-pmtr 'CallStyle)
                     (tpl-pmtr 'ExprType)
                     (tpl-pmtr FT-chunk))
               (r-fcn-def (fcn-dcl 'nebo_assignment_general_execute
                                   (b s FT-chunk const-chunk "&")
                                   (list (b s FT-chunk "&" 'initial_lhs)
                                         (b s
                                            (tpl-use NE-chunk 'ExprType FT-chunk)
                                            const-chunk
                                            "&"
                                            'initial_rhs)))
                          (list (typedef (tpl-pmtr (scope (tpl-use 'IteratorStyle
                                                                   'CallStyle
                                                                   (tpl-pmtr (scope (scope 'structured
                                                                                           (tpl-use 'Minimum
                                                                                                    (tpl-pmtr (scope 'ExprType
                                                                                                                     report-VG-chunk))
                                                                                                    (tpl-pmtr (scope (scope 'structured
                                                                                                                            (tpl-use 'FromGhost
                                                                                                                                     (tpl-pmtr (scope FT-chunk 'Ghost))
                                                                                                                                     (tpl-pmtr (scope (scope FT-chunk 'Location)
                                                                                                                                                      'BCExtra))))
                                                                                                                     'result))))
                                                                                    'result))
                                                                   (c (scope 'structured (tpl-use 'GhostData
                                                                                                  "0" "0" "0"
                                                                                                  "0" "0" "0"
                                                                                                  "0" "0" "0")) s))
                                                          'result))
                                         'ValidGhost)
                                (typedef (scope 'structured (tpl-use 'IndexTriplet "0" "0" "0"))
                                         'InitialShift))
                          (c new-line-chunk
                             (let* ([sequential-call (fc (tpl-use 'nebo_assignment_sequential_execute 'ValidGhost 'InitialShift 'ExprType FT-chunk)
                                                         'initial_lhs
                                                         'initial_rhs)]
                                    [parallel-call (fc (tpl-use 'nebo_assignment_thread_parallel_execute 'ValidGhost 'InitialShift 'ExprType FT-chunk)
                                                         'initial_lhs
                                                         'initial_rhs
                                                         (fc 'get_nebo_soft_thread_count))])
                               (pp-conditional-ifdef-chunk
                                'FIELD_EXPRESSION_THREADS
                                (p (b s
                                      (fc 'is_nebo_thread_parallel)
                                      "?"
                                      parallel-call
                                      ":"
                                      sequential-call))
                                sequential-call))
                             new-line-chunk)))
      (build-assignment-style (c 'operator s "<<=")
                              (p (b s
                                    'lhs
                                    "<<="
                                    (fc (tpl-use NE-chunk 'ExprType FT-chunk)
                                        (fc 'ExprType 'rhs))))
                              'UseWholeIterator)
      (build-assignment-style 'interior_assign
                              (fc 'interior_assign
                                  'lhs
                                  (fc (tpl-use NE-chunk 'ExprType FT-chunk)
                                      (fc 'ExprType 'rhs)))
                              'UseInteriorIterator)
      )))
